<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v4.10.2"><!-- <link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin>
<link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin> --><link rel="preload" href="/fonts/CascadiaMonoNF.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/fonts/CascadiaMonoNF-SemiBold.woff2" as="font" type="font/woff2" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://johanneskonings.dev/blog/2021-08-27-aws_example_ddb_analytics/"><!-- Primary Meta Tags --><title>Example how to analyze DynamoDB item changes with Kinesis and Athena created with Terraform | Johannes Konings</title><meta name="title" content="Example how to analyze DynamoDB item changes with Kinesis and Athena created with Terraform | Johannes Konings"><meta name="description" content="This post is how stream data changes of a DynamoDb table via Kinesis Data Stream and Kinesis Firehose to S3, and analyze the data with Athena"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://johanneskonings.dev/blog/2021-08-27-aws_example_ddb_analytics/"><meta property="og:title" content="Example how to analyze DynamoDB item changes with Kinesis and Athena created with Terraform | Johannes Konings"><meta property="og:description" content="This post is how stream data changes of a DynamoDb table via Kinesis Data Stream and Kinesis Firehose to S3, and analyze the data with Athena"><meta property="og:image" content="https://johanneskonings.dev/open-graph.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://johanneskonings.dev/blog/2021-08-27-aws_example_ddb_analytics/"><meta property="twitter:title" content="Example how to analyze DynamoDB item changes with Kinesis and Athena created with Terraform | Johannes Konings"><meta property="twitter:description" content="This post is how stream data changes of a DynamoDb table via Kinesis Data Stream and Kinesis Firehose to S3, and analyze the data with Athena"><meta property="twitter:image" content="https://johanneskonings.dev/open-graph.jpg"><!-- Sitemap --><link rel="sitemap" href="/sitemap-index.xml"><!-- RSS Feed --><link rel="alternate" type="application/rss+xml" title="Example how to analyze DynamoDB item changes with Kinesis and Athena created with Terraform | Johannes Konings" href="https://johanneskonings.dev/rss.xml"><!-- Global Scripts --><script src="/js/theme.js"></script><script src="/js/scroll.js"></script><script src="/js/animate.js"></script><!-- <ViewTransitions  /> --><link rel="stylesheet" href="/_astro/_slug_.COeGf7i0.css"><script type="module" src="/_astro/hoisted.BGfjo5mV.js"></script></head> <body> <header id="header" class="fixed top-0 w-full h-16 z-50" data-astro-cid-3ef6ksr2> <div class="w-full h-full mx-auto px-5 max-w-screen-md">  <div class="relative h-full w-full" data-astro-cid-3ef6ksr2> <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2" data-astro-cid-3ef6ksr2> <nav class="hidden md:flex items-center justify-center text-sm gap-1" data-astro-cid-3ef6ksr2> <a href="/" class="h-8 rounded-full px-3 text-current flex items-center justify-center transition-colors duration-300 ease-in-out hover:bg-black/5 dark:hover:bg-white/20 hover:text-black dark:hover:text-white" data-astro-cid-3ef6ksr2> Home </a><a href="/blog" class="h-8 rounded-full px-3 flex items-center justify-center transition-colors duration-300 ease-in-out bg-black dark:bg-white text-white dark:text-black" data-astro-cid-3ef6ksr2> Blog </a> </nav> </div> <div class="buttons absolute right-0 top-1/2 -translate-y-1/2 flex gap-1" data-astro-cid-3ef6ksr2> <a href="/search" aria-label="Search blog posts and projects on Johannes Konings" class="hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#search" data-astro-cid-3ef6ksr2></use> </svg> </a> <a href="/rss.xml" target="_blank" aria-label="Rss feed for Johannes Konings" class="hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#rss" data-astro-cid-3ef6ksr2></use> </svg> </a> <button id="header-theme-button" aria-label="Toggle light and dark theme" class="hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg class="size-full block dark:hidden" data-astro-cid-3ef6ksr2> <use href="/ui.svg#sun" data-astro-cid-3ef6ksr2></use> </svg> <svg class="size-full hidden dark:block" data-astro-cid-3ef6ksr2> <use href="/ui.svg#moon" data-astro-cid-3ef6ksr2></use> </svg> </button> <button id="header-drawer-button" aria-label="Toggle drawer open and closed" class="flex md:hidden size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg id="drawer-open" class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#menu" data-astro-cid-3ef6ksr2></use> </svg> <svg id="drawer-close" class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#x" data-astro-cid-3ef6ksr2></use> </svg> </button> </div> </div>  </div> </header>  <script>
  function toggleDrawer() {
    const drawer = document.getElementById("drawer");
    const drawerButton = document.getElementById("header-drawer-button");
    drawer?.classList.toggle("open");
    drawerButton?.classList.toggle("open");
  }

  function initializeDrawerButton() {
    const drawerButton = document.getElementById("header-drawer-button");
    drawerButton?.addEventListener("click", toggleDrawer);
  }

  document.addEventListener("astro:after-swap", initializeDrawerButton);
  initializeDrawerButton();
</script> <div id="drawer" class="fixed inset-0 h-0 z-40 overflow-hidden flex flex-col items-center justify-center md:hidden bg-neutral-100 dark:bg-neutral-900 transition-[height] duration-300 ease-in-out" data-astro-cid-hxtyo74s> <nav class="flex flex-col items-center space-y-2" data-astro-cid-hxtyo74s> <a href="/" class="flex items-center justify-center px-3 py-1 rounded-full text-current hover:text-black dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/20 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> Home </a><a href="/blog" class="flex items-center justify-center px-3 py-1 rounded-full hover:text-black dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/20 transition-colors duration-300 ease-in-out pointer-events-none bg-black dark:bg-white text-white dark:text-black" data-astro-cid-hxtyo74s> Blog </a> </nav> <div class="flex gap-1 mt-5" data-astro-cid-hxtyo74s> <a href="/search" aria-label="Search blog posts and projects on Johannes Konings" class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> <svg class="size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#search" data-astro-cid-hxtyo74s></use> </svg> </a> <a href="/rss.xml" target="_blank" aria-label="Rss feed for Johannes Konings" class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> <svg class="size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#rss" data-astro-cid-hxtyo74s></use> </svg> </a> <button id="drawer-theme-button" aria-label="Toggle light and dark theme" class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> <svg class="block dark:hidden size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#sun" data-astro-cid-hxtyo74s></use> </svg> <svg class="hidden dark:block size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#moon" data-astro-cid-hxtyo74s></use> </svg> </button> </div> </div>  <main>  <div class="pt-36 pb-5"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">   <div class="animate"> <div> <a href="/blog" class="group w-fit p-1.5 gap-1.5 text-sm flex items-center border rounded hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white"> <line x1="19" y1="12" x2="5" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-3 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></line> <polyline points="12 19 5 12 12 5" class="translate-x-1 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></polyline> </svg> <div class="w-full group-hover:text-black group-hover:dark:text-white transition-colors duration-300 ease-in-out">
Back to blog </div> </a> <div class="flex flex-wrap text-sm uppercase mt-12 gap-3 opacity-75"> <div class="flex items-center gap-2"> <svg class="size-5 stroke-current"> <use href="/ui.svg#calendar"></use> </svg> Aug 27, 2021 </div> <div class="flex items-center gap-2"> <svg class="size-5 stroke-current"> <use href="/ui.svg#book-open"></use> </svg> 5 min read </div> </div> <h1 class="text-3xl font-semibold text-black dark:text-white mt-2"> Example how to analyze DynamoDB item changes with Kinesis and Athena created with Terraform </h1> <div class="mt-1"> This post is how stream data changes of a DynamoDb table via Kinesis Data Stream and Kinesis Firehose to S3, and analyze the data with Athena </div> <!-- {(demoUrl || repoUrl) && 
  <div class="mt-4 flex flex-wrap gap-2">
    {demoUrl && 
      <a href={demoUrl} target="_blank" class="group flex gap-2 items-center px-3 py-1.5 truncate rounded text-xs md:text-sm lg:text-base border border-black/25 dark:border-white/25 hover:bg-black/5 hover:dark:bg-white/15 blend">
        <svg class="size-4">
          <use href="/ui.svg#globe" class="fill-current group-hover:fill-black group-hover:dark:fill-white blend"/>
        </svg>
        <span class="text-current group-hover:text-black group-hover:dark:text-white blend">
          See Demo
        </span>
      </a>
    }
    {repoUrl && 
      <a href={repoUrl} target="_blank" class="group flex gap-2 items-center px-3 py-1.5 truncate rounded text-xs md:text-sm lg:text-base border border-black/25 dark:border-white/25 hover:bg-black/5 hover:dark:bg-white/15 blend">
        <svg class="size-4">
          <use href="/ui.svg#link" class="fill-current group-hover:fill-black group-hover:dark:fill-white blend"/>
        </svg>
        <span class="text-current group-hover:text-black group-hover:dark:text-white blend">
          See Repository
        </span>
      </a>
    }
  </div> 
  } --> </div> </div>   </div> </div> <div class="flex-1 py-5"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">   <div class="animate"> <div> <article> <h1 id="why">Why?</h1>
<p>The data of a DynamoDb table is not so easy to analyze as a <a href="https://aws.amazon.com/rds/">RDS</a> with e.g., the <a href="https://www.pgadmin.org/">pgAdmin</a>.
It will be somehow possible with scan operation but it’s in the most cases <a href="https://dynobase.dev/dynamodb-scan/">not recommented</a>.</p>
<p>Another possibility is the <a href="https://aws.amazon.com/blogs/aws/new-export-amazon-dynamodb-table-data-to-data-lake-amazon-s3/">export to S3 functionylity</a>.</p>
<p>In this post, it’s described to use streams. Since 11/2020, it is also possible <a href="https://aws.amazon.com/about-aws/whats-new/2020/11/now-you-can-use-amazon-kinesis-data-streams-to-capture-item-level-changes-in-your-amazon-dynamodb-table/">to use kinesis data streams</a> for such a case.</p>
<p>That also allows to analyze changes and use it for audits.</p>
<p>A example with DynamoDb streams are here:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=7QFUEh-FYYE">https://www.youtube.com/watch?v=7QFUEh-FYYE</a></li>
<li><a href="https://www.youtube.com/watch?v=17AmrTqn0GY">https://www.youtube.com/watch?v=17AmrTqn0GY</a></li>
</ul>
<h1 id="architecture">Architecture</h1>
<p><img src="https://raw.githubusercontent.com/JohannesKonings/test-aws-dynamodb-athena-tf/main/diagrams/overview.png" alt="architecture"></p>
<p>The lambda is sending fake person data to DynamoDb. The integration of the Kinesis Data Stream into the DynamoDb is connected to the Kinesis Firehose, which sends the changes partitioned to the S3 bucket.</p>
<p>The Glue crawler will recognize the data structure and create a table, which can be accessed from Athena to analyze the data.</p>
<p>Let’s see the certain building blocks</p>
<h1 id="lambda-for-data-creation">Lambda (for data creation)</h1>
<p>The <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-tf/blob/main/terraform/lambda.tf">Lambda</a> is created with a module from <a href="serverless.tf">serverless.tf</a>.</p>
<p>The source code is <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-tf/blob/main/terraform/src/persons-loader/index.js">here</a></p>
<p>The number of created persons depends on the test event.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="json"><code><span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#79B8FF">  "batchSize"</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">5</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h1 id="dynamodb-and-kinesis-data-stream">DynamoDb and Kinesis Data Stream</h1>
<p><a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-tf/blob/main/terraform/dynamodb.tf">This</a> is the creation of the DynamoDb with the Kinesis Data Stream.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="terraform"><code><span class="line"><span style="color:#B392F0">resource</span><span style="color:#79B8FF"> "aws_dynamodb_table"</span><span style="color:#79B8FF"> "aws_dynamodb_table"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  name</span><span style="color:#F97583">         =</span><span style="color:#E1E4E8"> var</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">TABLE_NAME</span></span>
<span class="line"><span style="color:#E1E4E8">  billing_mode</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "PAY_PER_REQUEST"</span></span>
<span class="line"><span style="color:#E1E4E8">  hash_key</span><span style="color:#F97583">     =</span><span style="color:#9ECBFF"> "pk"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  attribute</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    name</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "pk"</span></span>
<span class="line"><span style="color:#E1E4E8">    type</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "S"</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">resource</span><span style="color:#79B8FF"> "aws_kinesis_stream"</span><span style="color:#79B8FF"> "aws_kinesis_stream"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  name</span><span style="color:#F97583">            =</span><span style="color:#9ECBFF"> "</span><span style="color:#F97583">${</span><span style="color:#E1E4E8">var</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">TABLE_NAME</span><span style="color:#F97583">}</span><span style="color:#9ECBFF">-data-stream"</span></span>
<span class="line"><span style="color:#E1E4E8">  shard_count</span><span style="color:#F97583">     =</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#E1E4E8">  encryption_type</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "KMS"</span></span>
<span class="line"><span style="color:#E1E4E8">  kms_key_id</span><span style="color:#F97583">      =</span><span style="color:#E1E4E8"> aws_kms_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_kms_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">arn</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">resource</span><span style="color:#79B8FF"> "aws_dynamodb_kinesis_streaming_destination"</span><span style="color:#79B8FF"> "aws_dynamodb_kinesis_streaming_destination"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  stream_arn</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> aws_kinesis_stream</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_kinesis_stream</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">arn</span></span>
<span class="line"><span style="color:#E1E4E8">  table_name</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> aws_dynamodb_table</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_dynamodb_table</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">name</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>That adds to the DynamoDb, a Kinesis Data Stream, and connects it to the DynamoDb.</p>
<p>![kinesis data stream]({{ site.baseurl }}/img/2021-08-27-aws_example_ddb_analytics/kinesis_data_stream.png)</p>
<p>![kinesis data stream ddb]({{ site.baseurl }}/img/2021-08-27-aws_example_ddb_analytics/kinesis_data_stream_ddb.png)</p>
<h1 id="kinesis-data-firehose-and-s3-bucket">Kinesis Data Firehose and S3 Bucket</h1>
<p>Kinesis Data Firehose is the connection between the Kinesis Data Stream to the S3 Bucket.</p>
<p>Unfortunately, Firehose stores the JSONs without a linefeed. Therefore it’s a lambda for conversion is necessary.</p>
<p>More about that is described in this <a href="https://medium.com/analytics-vidhya/append-newline-to-amazon-kinesis-firehose-json-formatted-records-with-python-f58498d0177a">post</a></p>
<p>Besides policy configuration, it looks like this.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="terraform"><code><span class="line"><span style="color:#B392F0">resource</span><span style="color:#79B8FF"> "aws_kinesis_firehose_delivery_stream"</span><span style="color:#79B8FF"> "aws_kinesis_firehose_delivery_stream"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  name</span><span style="color:#F97583">        =</span><span style="color:#E1E4E8"> local</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">firehose-name</span></span>
<span class="line"><span style="color:#E1E4E8">  destination</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "extended_s3"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  kinesis_source_configuration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    kinesis_stream_arn</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> aws_kinesis_stream</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_kinesis_stream</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">arn</span></span>
<span class="line"><span style="color:#E1E4E8">    role_arn</span><span style="color:#F97583">           =</span><span style="color:#E1E4E8"> aws_iam_role</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_iam_role</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">arn</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  extended_s3_configuration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    role_arn</span><span style="color:#F97583">   =</span><span style="color:#E1E4E8"> aws_iam_role</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_iam_role</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">arn</span></span>
<span class="line"><span style="color:#E1E4E8">    bucket_arn</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> aws_s3_bucket</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_s3_bucket</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">arn</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    processing_configuration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      enabled</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "true"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">      processors</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        type</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "Lambda"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">        parameters</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">          parameter_name</span><span style="color:#F97583">  =</span><span style="color:#9ECBFF"> "LambdaArn"</span></span>
<span class="line"><span style="color:#E1E4E8">          parameter_value</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "</span><span style="color:#F97583">${</span><span style="color:#E1E4E8">module</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">lambda_function_persons_firehose_converter</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">lambda_function_arn</span><span style="color:#F97583">}</span><span style="color:#9ECBFF">:$LATEST"</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    cloudwatch_logging_options</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      enabled</span><span style="color:#F97583">         =</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#E1E4E8">      log_group_name</span><span style="color:#F97583">  =</span><span style="color:#E1E4E8"> aws_cloudwatch_log_group</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_cloudwatch_log_group_firehose</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">name</span></span>
<span class="line"><span style="color:#E1E4E8">      log_stream_name</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> aws_cloudwatch_log_stream</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_cloudwatch_log_stream_firehose</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">name</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Details are <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-tf/blob/main/terraform/kinesis_firehose.tf">here</a></p>
<p>The delivery of the data to the S3 bucket is buffered. Here are the default values.</p>
<p>![firehose-buffer]({{ site.baseurl }}/img/2021-08-27-aws_example_ddb_analytics/firehose_buffer.png)</p>
<h1 id="glue-crawler">Glue crawler</h1>
<p>Athena needs a structured table for the SQL queries. The Glue crawler creates this from the data in the S3 bucket.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="terraform"><code><span class="line"><span style="color:#B392F0">resource</span><span style="color:#79B8FF"> "aws_glue_crawler"</span><span style="color:#79B8FF"> "aws_glue_crawler"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  database_name</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> aws_glue_catalog_database</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_glue_bookings_database</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">name</span></span>
<span class="line"><span style="color:#E1E4E8">  name</span><span style="color:#F97583">          =</span><span style="color:#E1E4E8"> local</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">glue-crawler-name</span></span>
<span class="line"><span style="color:#E1E4E8">  role</span><span style="color:#F97583">          =</span><span style="color:#E1E4E8"> aws_iam_role</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_iam_role_glue_crawler</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">arn</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  configuration</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> jsonencode</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#9ECBFF">      "Version"</span><span style="color:#F97583"> :</span><span style="color:#79B8FF"> 1.0</span></span>
<span class="line"><span style="color:#E1E4E8">      CrawlerOutput </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        Partitions </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> { AddOrUpdateBehavior </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> "InheritFromTable"</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  s3_target</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    path</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "s3://</span><span style="color:#F97583">${</span><span style="color:#E1E4E8">aws_s3_bucket</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_s3_bucket</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">bucket</span><span style="color:#F97583">}</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Details <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-tf/blob/main/terraform/glue.tf">here</a></p>
<p>For test purposes, it’s enough to run the crawler before any analysis. Scheduling is also possible.</p>
<p>![glue-run-crawler]({{ site.baseurl }}/img/2021-08-27-aws_example_ddb_analytics/glue_run_crawler.png)</p>
<p>That creates this table, which is accessible by Athena.</p>
<p>![glue-table]({{ site.baseurl }}/img/2021-08-27-aws_example_ddb_analytics/glue_table.png)</p>
<h1 id="athena">Athena</h1>
<p>For Athena it needs an S3 bucket for the query results and, for better isolation to other projects, a workgroup.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="terraform"><code><span class="line"><span style="color:#B392F0">locals</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  athena-query-results-s3-name</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "</span><span style="color:#F97583">${</span><span style="color:#E1E4E8">var</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">TABLE_NAME</span><span style="color:#F97583">}</span><span style="color:#9ECBFF">-query-results"</span></span>
<span class="line"><span style="color:#E1E4E8">  athena-workgroup-name</span><span style="color:#F97583">        =</span><span style="color:#9ECBFF"> "</span><span style="color:#F97583">${</span><span style="color:#E1E4E8">var</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">TABLE_NAME</span><span style="color:#F97583">}</span><span style="color:#9ECBFF">-workgroup"</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#B392F0">resource</span><span style="color:#79B8FF"> "aws_s3_bucket"</span><span style="color:#79B8FF"> "aws_s3_bucket_bookings_query_results"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  bucket</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> local</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">athena-query-results-s3-name</span></span>
<span class="line"><span style="color:#E1E4E8">  acl</span><span style="color:#F97583">    =</span><span style="color:#9ECBFF"> "private"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  versioning</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    enabled</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  server_side_encryption_configuration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    rule</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">      apply_server_side_encryption_by_default</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        kms_master_key_id</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> aws_kms_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_kms_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">arn</span></span>
<span class="line"><span style="color:#E1E4E8">        sse_algorithm</span><span style="color:#F97583">     =</span><span style="color:#9ECBFF"> "aws:kms"</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">resource</span><span style="color:#79B8FF"> "aws_athena_workgroup"</span><span style="color:#79B8FF"> "aws_athena_workgroup"</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  name</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> local</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">athena-workgroup-name</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  configuration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    enforce_workgroup_configuration</span><span style="color:#F97583">    =</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#E1E4E8">    publish_cloudwatch_metrics_enabled</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    result_configuration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      output_location</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "s3://</span><span style="color:#F97583">${</span><span style="color:#E1E4E8">aws_s3_bucket</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_s3_bucket_bookings_query_results</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">bucket</span><span style="color:#F97583">}</span><span style="color:#9ECBFF">/output/"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">      encryption_configuration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        encryption_option</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> "SSE_KMS"</span></span>
<span class="line"><span style="color:#E1E4E8">        kms_key_arn</span><span style="color:#F97583">       =</span><span style="color:#E1E4E8"> aws_kms_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">aws_kms_key</span><span style="color:#F97583">.</span><span style="color:#E1E4E8">arn</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Details <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-tf/blob/main/terraform/glue.tf">here</a></p>
<h2 id="analysis">Analysis</h2>
<p>First select the new workgroup.</p>
<p>![athena-workgroup]({{ site.baseurl }}/img/2021-08-27-aws_example_ddb_analytics/athena_workgroup.png)</p>
<p>And than the new Database.</p>
<p>![athena-database]({{ site.baseurl }}/img/2021-08-27-aws_example_ddb_analytics/athena_database.png)</p>
<h3 id="query-example">Query example</h3>
<p>DynamoDb sends the changes of an item as INSERT, MODIFY or REMOVE. To the current data of the table, this Query will work.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>SELECT dynamodb.newimage.pk.s AS pk,</span></span>
<span class="line"><span>         dynamodb.newimage.person.M.firstname.s AS firstname,</span></span>
<span class="line"><span>         dynamodb.newimage.person.M.lastname.s AS lastname,</span></span>
<span class="line"><span>         dynamodb.approximatecreationdatetime AS ts,</span></span>
<span class="line"><span>         dynamodb.newimage,</span></span>
<span class="line"><span>         *</span></span>
<span class="line"><span>FROM "persons-db"."persons_firehose_s3_bucket" AS persons1</span></span>
<span class="line"><span>WHERE (eventname = 'INSERT'</span></span>
<span class="line"><span>        OR eventname = 'MODIFY')</span></span>
<span class="line"><span>        AND dynamodb.approximatecreationdatetime =</span></span>
<span class="line"><span>    (SELECT MAX(dynamodb.approximatecreationdatetime)</span></span>
<span class="line"><span>    FROM "persons-db"."persons_firehose_s3_bucket" AS persons2</span></span>
<span class="line"><span>    WHERE persons2.dynamodb.newimage.pk.s = persons1.dynamodb.newimage.pk.s);</span></span>
<span class="line"><span></span></span></code></pre>
<p>![athena-ddb]({{ site.baseurl }}/img/2021-08-27-aws_example_ddb_analytics/athena_ddb.png)</p>
<h1 id="cost-alert">Cost Alert 💰</h1>
<p>⚠️ Don’t forget to destroy after testing. Kinesis Data Streams has <a href="https://aws.amazon.com/kinesis/data-streams/pricing/">costs</a> per hour</p>
<h1 id="code">Code</h1>
<p><a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-tf">https://github.com/JohannesKonings/test-aws-dynamodb-athena-tf</a></p> </article> <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"> <a href="/blog/2021-10-26-aws_example_ddb_analytics_cdk" class="group p-4 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 blend"> <div class="order-2 w-full h-full group-hover:text-black group-hover:dark:text-white blend"> <div class="flex flex-wrap gap-2"> <div class="text-sm uppercase">
Prev
</div> </div> <div class="font-semibold mt-3 text-black dark:text-white"> Example how to analyze DynamoDB item changes with Kinesis and Athena created with CDK </div> </div> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="order-1 stroke-current group-hover:stroke-black group-hover:dark:stroke-white rotate-180"> <line x1="5" y1="12" x2="19" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-4 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></line> <polyline points="12 5 19 12 12 19" class="translate-x-0 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></polyline> </svg> </a> <a href="/blog/2021-02-28-github_automatic_releases_and-changelog" class="group p-4 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"> <div class="w-full h-full text-right group-hover:text-black group-hover:dark:text-white blend"> <div class="text-sm uppercase">
Next
</div> <div class="font-semibold mt-3 text-black dark:text-white"> GitHub actions example for automatic release drafts and changelog.md creation </div> </div> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white"> <line x1="5" y1="12" x2="19" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-4 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></line> <polyline points="12 5 19 12 12 19" class="translate-x-0 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></polyline> </svg> </a> </div> </div> </div>   </div> </div>  </main> <footer class="relative bg-white dark:bg-black"> <div class="animate"> <section class="py-5"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">  <div class="flex items-center justify-center sm:justify-end"> <button id="back-to-top" aria-label="Back to top of page" class="group flex w-fit p-1.5 gap-1.5 text-sm items-center border rounded hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white rotate-90"> <line x1="19" y1="12" x2="5" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-3 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></line> <polyline points="12 19 5 12 12 5" class="translate-x-1 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></polyline> </svg> <div class="w-full group-hover:text-black group-hover:dark:text-white transition-colors duration-300 ease-in-out">
Back to top
</div> </button> </div>  </div> </section> <section class="py-5 overflow-hidden whitespace-nowrap border-t border-black/10 dark:border-white/25"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">  <div class="h-full grid grid-cols-1 sm:grid-cols-2 gap-3"> <div class="order-2 sm:order-1 flex flex-col items-center justify-center sm:items-start"> <div class="legal"> <a href="/legal/terms" class="text-current hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out">
Terms
</a> |
<a href="/legal/privacy" class="text-current hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out">
Privacy
</a> </div> <div class="text-sm mt-2">&copy; 2024 | All rights reserved</div> </div> <div class="order-1 sm:order-2 flex justify-center sm:justify-end"> <div class="flex flex-wrap gap-1 items-center justify-center"> <!-- {
                SOCIALS.map((SOCIAL) => (
                  <a 
                    href={SOCIAL.HREF} 
                    target="_blank" 
                    aria-label={`${SITE.TITLE} on ${SOCIAL.NAME}`} 
                    class="group size-10 rounded-full p-2 items-center justify-center hover:bg-black/5 dark:hover:bg-white/20  blend"
                  >
                    <svg class="size-full fill-current group-hover:fill-black group-hover:dark:fill-white blend">
                      <use href={`/social.svg#${SOCIAL.ICON}`} />
                    </svg>
                  </a>
                ))
              } --> <a href="https://github.com/JohannesKonings/JohannesKonings.github.io" target="_blank" aria-label="GitHub repo" class="group size-10 rounded-full p-2 items-center justify-center hover:bg-black/5 dark:hover:bg-white/20 blend"> <svg class="size-full fill-current group-hover:fill-black group-hover:dark:fill-white blend"> <use href="/social.svg#github"></use> </svg> </a> </div> </div> </div>  </div> </section> </div> </footer> <script>
  function goBackToTop(event) {
    event.preventDefault();
    window.scrollTo({
      top: 0,
      behavior: "smooth",
    });
  }

  function inintializeBackToTop() {
    const backToTop = document.getElementById("back-to-top");
    backToTop?.addEventListener("click", goBackToTop);
  }

  document.addEventListener("astro:after-swap", inintializeBackToTop);
  inintializeBackToTop();
</script> </body></html>
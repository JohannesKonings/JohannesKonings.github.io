<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v4.10.2"><!-- <link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin>
<link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin> --><link rel="preload" href="/fonts/CascadiaMonoNF.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/fonts/CascadiaMonoNF-SemiBold.woff2" as="font" type="font/woff2" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://johanneskonings.dev/blog/2022-08-22-aws_example_ddb_analytics_athena_saved_queries_cdk/"><!-- Primary Meta Tags --><title>Example how to create Athena saved queries with CDK | Johannes Konings</title><meta name="title" content="Example how to create Athena saved queries with CDK | Johannes Konings"><meta name="description" content="This post is about how saved queries are created with CDK. This is useful to have important queries prepared for any users."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://johanneskonings.dev/blog/2022-08-22-aws_example_ddb_analytics_athena_saved_queries_cdk/"><meta property="og:title" content="Example how to create Athena saved queries with CDK | Johannes Konings"><meta property="og:description" content="This post is about how saved queries are created with CDK. This is useful to have important queries prepared for any users."><meta property="og:image" content="https://johanneskonings.dev/open-graph.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://johanneskonings.dev/blog/2022-08-22-aws_example_ddb_analytics_athena_saved_queries_cdk/"><meta property="twitter:title" content="Example how to create Athena saved queries with CDK | Johannes Konings"><meta property="twitter:description" content="This post is about how saved queries are created with CDK. This is useful to have important queries prepared for any users."><meta property="twitter:image" content="https://johanneskonings.dev/open-graph.jpg"><!-- Sitemap --><link rel="sitemap" href="/sitemap-index.xml"><!-- RSS Feed --><link rel="alternate" type="application/rss+xml" title="Example how to create Athena saved queries with CDK | Johannes Konings" href="https://johanneskonings.dev/rss.xml"><!-- Global Scripts --><script src="/js/theme.js"></script><script src="/js/scroll.js"></script><script src="/js/animate.js"></script><!-- <ViewTransitions  /> --><link rel="stylesheet" href="/_astro/_slug_.COeGf7i0.css"><script type="module" src="/_astro/hoisted.BGfjo5mV.js"></script></head> <body> <header id="header" class="fixed top-0 w-full h-16 z-50" data-astro-cid-3ef6ksr2> <div class="w-full h-full mx-auto px-5 max-w-screen-md">  <div class="relative h-full w-full" data-astro-cid-3ef6ksr2> <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2" data-astro-cid-3ef6ksr2> <nav class="hidden md:flex items-center justify-center text-sm gap-1" data-astro-cid-3ef6ksr2> <a href="/" class="h-8 rounded-full px-3 text-current flex items-center justify-center transition-colors duration-300 ease-in-out hover:bg-black/5 dark:hover:bg-white/20 hover:text-black dark:hover:text-white" data-astro-cid-3ef6ksr2> Home </a><a href="/blog" class="h-8 rounded-full px-3 flex items-center justify-center transition-colors duration-300 ease-in-out bg-black dark:bg-white text-white dark:text-black" data-astro-cid-3ef6ksr2> Blog </a> </nav> </div> <div class="buttons absolute right-0 top-1/2 -translate-y-1/2 flex gap-1" data-astro-cid-3ef6ksr2> <a href="/search" aria-label="Search blog posts and projects on Johannes Konings" class="hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#search" data-astro-cid-3ef6ksr2></use> </svg> </a> <a href="/rss.xml" target="_blank" aria-label="Rss feed for Johannes Konings" class="hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#rss" data-astro-cid-3ef6ksr2></use> </svg> </a> <button id="header-theme-button" aria-label="Toggle light and dark theme" class="hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg class="size-full block dark:hidden" data-astro-cid-3ef6ksr2> <use href="/ui.svg#sun" data-astro-cid-3ef6ksr2></use> </svg> <svg class="size-full hidden dark:block" data-astro-cid-3ef6ksr2> <use href="/ui.svg#moon" data-astro-cid-3ef6ksr2></use> </svg> </button> <button id="header-drawer-button" aria-label="Toggle drawer open and closed" class="flex md:hidden size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg id="drawer-open" class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#menu" data-astro-cid-3ef6ksr2></use> </svg> <svg id="drawer-close" class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#x" data-astro-cid-3ef6ksr2></use> </svg> </button> </div> </div>  </div> </header>  <script>
  function toggleDrawer() {
    const drawer = document.getElementById("drawer");
    const drawerButton = document.getElementById("header-drawer-button");
    drawer?.classList.toggle("open");
    drawerButton?.classList.toggle("open");
  }

  function initializeDrawerButton() {
    const drawerButton = document.getElementById("header-drawer-button");
    drawerButton?.addEventListener("click", toggleDrawer);
  }

  document.addEventListener("astro:after-swap", initializeDrawerButton);
  initializeDrawerButton();
</script> <div id="drawer" class="fixed inset-0 h-0 z-40 overflow-hidden flex flex-col items-center justify-center md:hidden bg-neutral-100 dark:bg-neutral-900 transition-[height] duration-300 ease-in-out" data-astro-cid-hxtyo74s> <nav class="flex flex-col items-center space-y-2" data-astro-cid-hxtyo74s> <a href="/" class="flex items-center justify-center px-3 py-1 rounded-full text-current hover:text-black dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/20 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> Home </a><a href="/blog" class="flex items-center justify-center px-3 py-1 rounded-full hover:text-black dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/20 transition-colors duration-300 ease-in-out pointer-events-none bg-black dark:bg-white text-white dark:text-black" data-astro-cid-hxtyo74s> Blog </a> </nav> <div class="flex gap-1 mt-5" data-astro-cid-hxtyo74s> <a href="/search" aria-label="Search blog posts and projects on Johannes Konings" class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> <svg class="size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#search" data-astro-cid-hxtyo74s></use> </svg> </a> <a href="/rss.xml" target="_blank" aria-label="Rss feed for Johannes Konings" class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> <svg class="size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#rss" data-astro-cid-hxtyo74s></use> </svg> </a> <button id="drawer-theme-button" aria-label="Toggle light and dark theme" class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> <svg class="block dark:hidden size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#sun" data-astro-cid-hxtyo74s></use> </svg> <svg class="hidden dark:block size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#moon" data-astro-cid-hxtyo74s></use> </svg> </button> </div> </div>  <main>  <div class="pt-36 pb-5"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">   <div class="animate"> <div> <a href="/blog" class="group w-fit p-1.5 gap-1.5 text-sm flex items-center border rounded hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white"> <line x1="19" y1="12" x2="5" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-3 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></line> <polyline points="12 19 5 12 12 5" class="translate-x-1 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></polyline> </svg> <div class="w-full group-hover:text-black group-hover:dark:text-white transition-colors duration-300 ease-in-out">
Back to blog </div> </a> <div class="flex flex-wrap text-sm uppercase mt-12 gap-3 opacity-75"> <div class="flex items-center gap-2"> <svg class="size-5 stroke-current"> <use href="/ui.svg#calendar"></use> </svg> Aug 22, 2022 </div> <div class="flex items-center gap-2"> <svg class="size-5 stroke-current"> <use href="/ui.svg#book-open"></use> </svg> 4 min read </div> </div> <h1 class="text-3xl font-semibold text-black dark:text-white mt-2"> Example how to create Athena saved queries with CDK </h1> <div class="mt-1"> This post is about how saved queries are created with CDK. This is useful to have important queries prepared for any users. </div> <!-- {(demoUrl || repoUrl) && 
  <div class="mt-4 flex flex-wrap gap-2">
    {demoUrl && 
      <a href={demoUrl} target="_blank" class="group flex gap-2 items-center px-3 py-1.5 truncate rounded text-xs md:text-sm lg:text-base border border-black/25 dark:border-white/25 hover:bg-black/5 hover:dark:bg-white/15 blend">
        <svg class="size-4">
          <use href="/ui.svg#globe" class="fill-current group-hover:fill-black group-hover:dark:fill-white blend"/>
        </svg>
        <span class="text-current group-hover:text-black group-hover:dark:text-white blend">
          See Demo
        </span>
      </a>
    }
    {repoUrl && 
      <a href={repoUrl} target="_blank" class="group flex gap-2 items-center px-3 py-1.5 truncate rounded text-xs md:text-sm lg:text-base border border-black/25 dark:border-white/25 hover:bg-black/5 hover:dark:bg-white/15 blend">
        <svg class="size-4">
          <use href="/ui.svg#link" class="fill-current group-hover:fill-black group-hover:dark:fill-white blend"/>
        </svg>
        <span class="text-current group-hover:text-black group-hover:dark:text-white blend">
          See Repository
        </span>
      </a>
    }
  </div> 
  } --> </div> </div>   </div> </div> <div class="flex-1 py-5"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">   <div class="animate"> <div> <article> <p>In [this]({{ site.baseurl }}/aws/2021/08/27/aws_example_ddb_analytics/) post is a example of a Athena query to get the the current data of the DynamoDb table.</p>
<p>This post explains how to provide this query with CDK as a saved query in Athena to have the query stored “nearby” the editor and that the query fits to the current deployment regarding the naming of the DB and table.
Another advantage is to have the query under source control.</p>
<p>This is a extension of [this]({{ site.baseurl }}/aws/2021/10/26/aws_example_ddb_analytics_cdk/) post.</p>
<p>The saved queries are stored here in the console:</p>
<p>![athena save queries]({{ site.baseurl }}/img/2022-08-22-aws_example_ddb_analytics_athena_saved_queries_cdk/athena_saved_queries.png)</p>
<h1 id="the-sql-command">The SQL command</h1>
<p>This SQL command will be provided as a saved query in Athena. For easier maintenance, the command is in an extra <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/saved-queries/ddb-state.sql">SQL file</a>.
The DB and the table name are placeholders in the file and will be replaced during the deployment process. That ensures that this SQL command refers to the correct resources, which are also deployed.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#F97583">SELECT</span><span style="color:#79B8FF"> dynamodb</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">newimage</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">pk</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">s</span><span style="color:#F97583"> AS</span><span style="color:#E1E4E8"> pk,</span></span>
<span class="line"><span style="color:#79B8FF">        dynamodb</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">newimage</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">person</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">M</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">firstname</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">s</span><span style="color:#F97583"> AS</span><span style="color:#E1E4E8"> firstname,</span></span>
<span class="line"><span style="color:#79B8FF">        dynamodb</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">newimage</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">person</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">M</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">lastname</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">s</span><span style="color:#F97583"> AS</span><span style="color:#E1E4E8"> lastname,</span></span>
<span class="line"><span style="color:#79B8FF">        dynamodb</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">approximatecreationdatetime</span><span style="color:#F97583"> AS</span><span style="color:#E1E4E8"> ts,</span></span>
<span class="line"><span style="color:#79B8FF">        dynamodb</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">newimage</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">        *</span></span>
<span class="line"><span style="color:#F97583">FROM</span><span style="color:#9ECBFF"> "athenaDbName"</span><span style="color:#E1E4E8">.</span><span style="color:#9ECBFF">"athenaTableName"</span><span style="color:#F97583"> AS</span><span style="color:#E1E4E8"> persons1</span></span>
<span class="line"><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> (eventname </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'INSERT'</span></span>
<span class="line"><span style="color:#F97583">        OR</span><span style="color:#E1E4E8"> eventname </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'MODIFY'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        AND</span><span style="color:#79B8FF"> dynamodb</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">approximatecreationdatetime</span><span style="color:#F97583"> =</span></span>
<span class="line"><span style="color:#E1E4E8">    (</span><span style="color:#F97583">SELECT</span><span style="color:#79B8FF"> MAX</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">dynamodb</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">approximatecreationdatetime</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    FROM</span><span style="color:#9ECBFF"> "athenaDbName"</span><span style="color:#E1E4E8">.</span><span style="color:#9ECBFF">"athenaTableName"</span><span style="color:#F97583"> AS</span><span style="color:#E1E4E8"> persons2</span></span>
<span class="line"><span style="color:#F97583">    WHERE</span><span style="color:#79B8FF"> persons2</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">dynamodb</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">newimage</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">pk</span><span style="color:#E1E4E8">.s </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> persons1</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">dynamodb</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">newimage</span><span style="color:#E1E4E8">.</span><span style="color:#79B8FF">pk</span><span style="color:#E1E4E8">.s);</span></span>
<span class="line"></span></code></pre>
<h1 id="saved-query-construct">Saved Query Construct</h1>
<p>Like the SQL file, the CDK definition of the saved query is in an <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/saved-queries/saved-queries.ts">extra</a><a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/saved-queries/saved-queries.ts"> file</a> as a CDK construct.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { Construct } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'constructs'</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  aws_athena </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> athenaCfn</span></span>
<span class="line"><span style="color:#E1E4E8">} </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'aws-cdk-lib'</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#79B8FF"> *</span><span style="color:#F97583"> as</span><span style="color:#E1E4E8"> glue </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> '@aws-cdk/aws-glue-alpha'</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { readFileSync } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'fs'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { join } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'path'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> SavedQueriesProps</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  glueDb</span><span style="color:#F97583">:</span><span style="color:#B392F0"> glue</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">IDatabase</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  athenaTableName</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  athenaWorkgroupName</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> SavedQueries</span><span style="color:#F97583"> extends</span><span style="color:#B392F0"> Construct</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">scope</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Construct</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">id</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">props</span><span style="color:#F97583">:</span><span style="color:#B392F0"> SavedQueriesProps</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">    super</span><span style="color:#E1E4E8">(scope, id)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#B392F0"> getSqlString</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">file</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      let</span><span style="color:#E1E4E8"> personsDdbStateSqlCommand </span><span style="color:#F97583">=</span><span style="color:#B392F0"> readFileSync</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">join</span><span style="color:#E1E4E8">(__dirname, </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">file</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">), </span><span style="color:#9ECBFF">'utf-8'</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> athenaDbName</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> props.glueDb.databaseName</span></span>
<span class="line"><span style="color:#F97583">      let</span><span style="color:#E1E4E8"> athenaTableName </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> props.athenaTableName;</span></span>
<span class="line"><span style="color:#E1E4E8">      athenaTableName </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> athenaTableName.</span><span style="color:#B392F0">replace</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">/</span><span style="color:#DBEDFF">-</span><span style="color:#9ECBFF">/</span><span style="color:#F97583">g</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'_'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      personsDdbStateSqlCommand </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> personsDdbStateSqlCommand.</span><span style="color:#B392F0">replace</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">/</span><span style="color:#DBEDFF">athenaDbName</span><span style="color:#9ECBFF">/</span><span style="color:#F97583">g</span><span style="color:#E1E4E8">, athenaDbName)</span></span>
<span class="line"><span style="color:#E1E4E8">      personsDdbStateSqlCommand </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> personsDdbStateSqlCommand.</span><span style="color:#B392F0">replace</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">/</span><span style="color:#DBEDFF">athenaTableName</span><span style="color:#9ECBFF">/</span><span style="color:#F97583">g</span><span style="color:#E1E4E8">, athenaTableName)</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> personsDdbStateSqlCommand</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> queryString </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getSqlString</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'ddb-state.sql'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // eslint-disable-next-line no-new</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#E1E4E8"> athenaCfn.</span><span style="color:#B392F0">CfnNamedQuery</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'query-current-ddb-state'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">      database: props.glueDb.databaseName,</span></span>
<span class="line"><span style="color:#E1E4E8">      queryString: queryString,</span></span>
<span class="line"><span style="color:#E1E4E8">      description: </span><span style="color:#9ECBFF">'query the current state from the ddb table'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      name: </span><span style="color:#9ECBFF">'current-ddb-state'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      workGroup: props.athenaWorkgroupName</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Currently, there is no L2 Construct for a named query in CDK, so it is defined as a L1 CFN Resource (<code>CfnNamedQuery</code>).</p>
<p>This needs the query as a string. The function <code>getSqlString</code> converts and transforms the SQL file content to that needed string.</p>
<p>So that the placeholders are replaced with the resources, which are deployed.</p>
<p>The Athena table name will be created during the glue crawler process. The convention is that the table name configured prefix of the S3 bucket with an underscore (”_”) instead of dashes (”-”).</p>
<p>The database name and the workgroup name are passed from the stack to the construct.</p>
<h1 id="insert-the-saved-query-construct-in-the-stack">Insert the saved query construct in the stack</h1>
<p>For the deployment the saved queries construct will be inserted into the <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/cdk-stack.ts#L211">stack</a></p>
<p>The needed information are passed as props to the construct.</p>
<p>The saved queries are depending on the workgroup. That has to be defined in CDK. Otherwise, the deployment will fail.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> savedQueries</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> SavedQueries</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'saved-queries'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">      glueDb: glueDb,</span></span>
<span class="line"><span style="color:#E1E4E8">      athenaTableName: firehoseBucketName,</span></span>
<span class="line"><span style="color:#E1E4E8">      athenaWorkgroupName: athenaWorkgroup.name,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    savedQueries.node.</span><span style="color:#B392F0">addDependency</span><span style="color:#E1E4E8">(athenaWorkgroup);</span></span>
<span class="line"></span></code></pre>
<h1 id="result">Result</h1>
<p>After the deployment, the new query is listed here and can be chosen for query in the editor.</p>
<p>![athena save query deployed]({{ site.baseurl }}/img/2022-08-22-aws_example_ddb_analytics_athena_saved_queries_cdk/athena_saved_query_deployed.png)</p>
<p>![athena save queries]({{ site.baseurl }}/img/2022-08-22-aws_example_ddb_analytics_athena_saved_queries_cdk/athena_saved_query_editor.png)</p>
<h1 id="code">Code</h1>
<p><a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk">https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk</a></p> </article> <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"> <a href="/blog/2022-09-17-aws_example_ddb_analytics_quicksight_cdk" class="group p-4 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 blend"> <div class="order-2 w-full h-full group-hover:text-black group-hover:dark:text-white blend"> <div class="flex flex-wrap gap-2"> <div class="text-sm uppercase">
Prev
</div> </div> <div class="font-semibold mt-3 text-black dark:text-white"> Example how to visualize DynamoDB item changes with Quicksight (S3 source) created with CDK </div> </div> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="order-1 stroke-current group-hover:stroke-black group-hover:dark:stroke-white rotate-180"> <line x1="5" y1="12" x2="19" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-4 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></line> <polyline points="12 5 19 12 12 19" class="translate-x-0 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></polyline> </svg> </a> <a href="/blog/2021-10-26-aws_example_ddb_analytics_cdk" class="group p-4 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"> <div class="w-full h-full text-right group-hover:text-black group-hover:dark:text-white blend"> <div class="text-sm uppercase">
Next
</div> <div class="font-semibold mt-3 text-black dark:text-white"> Example how to analyze DynamoDB item changes with Kinesis and Athena created with CDK </div> </div> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white"> <line x1="5" y1="12" x2="19" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-4 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></line> <polyline points="12 5 19 12 12 19" class="translate-x-0 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></polyline> </svg> </a> </div> </div> </div>   </div> </div>  </main> <footer class="relative bg-white dark:bg-black"> <div class="animate"> <section class="py-5"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">  <div class="flex items-center justify-center sm:justify-end"> <button id="back-to-top" aria-label="Back to top of page" class="group flex w-fit p-1.5 gap-1.5 text-sm items-center border rounded hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white rotate-90"> <line x1="19" y1="12" x2="5" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-3 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></line> <polyline points="12 19 5 12 12 5" class="translate-x-1 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></polyline> </svg> <div class="w-full group-hover:text-black group-hover:dark:text-white transition-colors duration-300 ease-in-out">
Back to top
</div> </button> </div>  </div> </section> <section class="py-5 overflow-hidden whitespace-nowrap border-t border-black/10 dark:border-white/25"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">  <div class="h-full grid grid-cols-1 sm:grid-cols-2 gap-3"> <div class="order-2 sm:order-1 flex flex-col items-center justify-center sm:items-start"> <div class="legal"> <a href="/legal/terms" class="text-current hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out">
Terms
</a> |
<a href="/legal/privacy" class="text-current hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out">
Privacy
</a> </div> <div class="text-sm mt-2">&copy; 2024 | All rights reserved</div> </div> <div class="order-1 sm:order-2 flex justify-center sm:justify-end"> <div class="flex flex-wrap gap-1 items-center justify-center"> <!-- {
                SOCIALS.map((SOCIAL) => (
                  <a 
                    href={SOCIAL.HREF} 
                    target="_blank" 
                    aria-label={`${SITE.TITLE} on ${SOCIAL.NAME}`} 
                    class="group size-10 rounded-full p-2 items-center justify-center hover:bg-black/5 dark:hover:bg-white/20  blend"
                  >
                    <svg class="size-full fill-current group-hover:fill-black group-hover:dark:fill-white blend">
                      <use href={`/social.svg#${SOCIAL.ICON}`} />
                    </svg>
                  </a>
                ))
              } --> <a href="https://github.com/JohannesKonings/JohannesKonings.github.io" target="_blank" aria-label="GitHub repo" class="group size-10 rounded-full p-2 items-center justify-center hover:bg-black/5 dark:hover:bg-white/20 blend"> <svg class="size-full fill-current group-hover:fill-black group-hover:dark:fill-white blend"> <use href="/social.svg#github"></use> </svg> </a> </div> </div> </div>  </div> </section> </div> </footer> <script>
  function goBackToTop(event) {
    event.preventDefault();
    window.scrollTo({
      top: 0,
      behavior: "smooth",
    });
  }

  function inintializeBackToTop() {
    const backToTop = document.getElementById("back-to-top");
    backToTop?.addEventListener("click", goBackToTop);
  }

  document.addEventListener("astro:after-swap", inintializeBackToTop);
  inintializeBackToTop();
</script> </body></html>
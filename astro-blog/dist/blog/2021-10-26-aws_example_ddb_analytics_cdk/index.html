<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v4.10.2"><!-- <link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin>
<link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin> --><link rel="preload" href="/fonts/CascadiaMonoNF.woff2" as="font" type="font/woff2" crossorigin><link rel="preload" href="/fonts/CascadiaMonoNF-SemiBold.woff2" as="font" type="font/woff2" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://johanneskonings.dev/blog/2021-10-26-aws_example_ddb_analytics_cdk/"><!-- Primary Meta Tags --><title>Example how to analyze DynamoDB item changes with Kinesis and Athena created with CDK | Johannes Konings</title><meta name="title" content="Example how to analyze DynamoDB item changes with Kinesis and Athena created with CDK | Johannes Konings"><meta name="description" content="This post is how stream data changes of a DynamoDb table via Kinesis Data Stream and Kinesis Firehose to S3, and analyze the data with Athena. Build with CDK."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://johanneskonings.dev/blog/2021-10-26-aws_example_ddb_analytics_cdk/"><meta property="og:title" content="Example how to analyze DynamoDB item changes with Kinesis and Athena created with CDK | Johannes Konings"><meta property="og:description" content="This post is how stream data changes of a DynamoDb table via Kinesis Data Stream and Kinesis Firehose to S3, and analyze the data with Athena. Build with CDK."><meta property="og:image" content="https://johanneskonings.dev/open-graph.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://johanneskonings.dev/blog/2021-10-26-aws_example_ddb_analytics_cdk/"><meta property="twitter:title" content="Example how to analyze DynamoDB item changes with Kinesis and Athena created with CDK | Johannes Konings"><meta property="twitter:description" content="This post is how stream data changes of a DynamoDb table via Kinesis Data Stream and Kinesis Firehose to S3, and analyze the data with Athena. Build with CDK."><meta property="twitter:image" content="https://johanneskonings.dev/open-graph.jpg"><!-- Sitemap --><link rel="sitemap" href="/sitemap-index.xml"><!-- RSS Feed --><link rel="alternate" type="application/rss+xml" title="Example how to analyze DynamoDB item changes with Kinesis and Athena created with CDK | Johannes Konings" href="https://johanneskonings.dev/rss.xml"><!-- Global Scripts --><script src="/js/theme.js"></script><script src="/js/scroll.js"></script><script src="/js/animate.js"></script><!-- <ViewTransitions  /> --><link rel="stylesheet" href="/_astro/_slug_.COeGf7i0.css"><script type="module" src="/_astro/hoisted.BGfjo5mV.js"></script></head> <body> <header id="header" class="fixed top-0 w-full h-16 z-50" data-astro-cid-3ef6ksr2> <div class="w-full h-full mx-auto px-5 max-w-screen-md">  <div class="relative h-full w-full" data-astro-cid-3ef6ksr2> <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2" data-astro-cid-3ef6ksr2> <nav class="hidden md:flex items-center justify-center text-sm gap-1" data-astro-cid-3ef6ksr2> <a href="/" class="h-8 rounded-full px-3 text-current flex items-center justify-center transition-colors duration-300 ease-in-out hover:bg-black/5 dark:hover:bg-white/20 hover:text-black dark:hover:text-white" data-astro-cid-3ef6ksr2> Home </a><a href="/blog" class="h-8 rounded-full px-3 flex items-center justify-center transition-colors duration-300 ease-in-out bg-black dark:bg-white text-white dark:text-black" data-astro-cid-3ef6ksr2> Blog </a> </nav> </div> <div class="buttons absolute right-0 top-1/2 -translate-y-1/2 flex gap-1" data-astro-cid-3ef6ksr2> <a href="/search" aria-label="Search blog posts and projects on Johannes Konings" class="hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#search" data-astro-cid-3ef6ksr2></use> </svg> </a> <a href="/rss.xml" target="_blank" aria-label="Rss feed for Johannes Konings" class="hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#rss" data-astro-cid-3ef6ksr2></use> </svg> </a> <button id="header-theme-button" aria-label="Toggle light and dark theme" class="hidden md:flex size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg class="size-full block dark:hidden" data-astro-cid-3ef6ksr2> <use href="/ui.svg#sun" data-astro-cid-3ef6ksr2></use> </svg> <svg class="size-full hidden dark:block" data-astro-cid-3ef6ksr2> <use href="/ui.svg#moon" data-astro-cid-3ef6ksr2></use> </svg> </button> <button id="header-drawer-button" aria-label="Toggle drawer open and closed" class="flex md:hidden size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-3ef6ksr2> <svg id="drawer-open" class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#menu" data-astro-cid-3ef6ksr2></use> </svg> <svg id="drawer-close" class="size-full" data-astro-cid-3ef6ksr2> <use href="/ui.svg#x" data-astro-cid-3ef6ksr2></use> </svg> </button> </div> </div>  </div> </header>  <script>
  function toggleDrawer() {
    const drawer = document.getElementById("drawer");
    const drawerButton = document.getElementById("header-drawer-button");
    drawer?.classList.toggle("open");
    drawerButton?.classList.toggle("open");
  }

  function initializeDrawerButton() {
    const drawerButton = document.getElementById("header-drawer-button");
    drawerButton?.addEventListener("click", toggleDrawer);
  }

  document.addEventListener("astro:after-swap", initializeDrawerButton);
  initializeDrawerButton();
</script> <div id="drawer" class="fixed inset-0 h-0 z-40 overflow-hidden flex flex-col items-center justify-center md:hidden bg-neutral-100 dark:bg-neutral-900 transition-[height] duration-300 ease-in-out" data-astro-cid-hxtyo74s> <nav class="flex flex-col items-center space-y-2" data-astro-cid-hxtyo74s> <a href="/" class="flex items-center justify-center px-3 py-1 rounded-full text-current hover:text-black dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/20 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> Home </a><a href="/blog" class="flex items-center justify-center px-3 py-1 rounded-full hover:text-black dark:hover:text-white hover:bg-black/5 dark:hover:bg-white/20 transition-colors duration-300 ease-in-out pointer-events-none bg-black dark:bg-white text-white dark:text-black" data-astro-cid-hxtyo74s> Blog </a> </nav> <div class="flex gap-1 mt-5" data-astro-cid-hxtyo74s> <a href="/search" aria-label="Search blog posts and projects on Johannes Konings" class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> <svg class="size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#search" data-astro-cid-hxtyo74s></use> </svg> </a> <a href="/rss.xml" target="_blank" aria-label="Rss feed for Johannes Konings" class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> <svg class="size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#rss" data-astro-cid-hxtyo74s></use> </svg> </a> <button id="drawer-theme-button" aria-label="Toggle light and dark theme" class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out" data-astro-cid-hxtyo74s> <svg class="block dark:hidden size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#sun" data-astro-cid-hxtyo74s></use> </svg> <svg class="hidden dark:block size-full" data-astro-cid-hxtyo74s> <use href="/ui.svg#moon" data-astro-cid-hxtyo74s></use> </svg> </button> </div> </div>  <main>  <div class="pt-36 pb-5"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">   <div class="animate"> <div> <a href="/blog" class="group w-fit p-1.5 gap-1.5 text-sm flex items-center border rounded hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white"> <line x1="19" y1="12" x2="5" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-3 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></line> <polyline points="12 19 5 12 12 5" class="translate-x-1 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></polyline> </svg> <div class="w-full group-hover:text-black group-hover:dark:text-white transition-colors duration-300 ease-in-out">
Back to blog </div> </a> <div class="flex flex-wrap text-sm uppercase mt-12 gap-3 opacity-75"> <div class="flex items-center gap-2"> <svg class="size-5 stroke-current"> <use href="/ui.svg#calendar"></use> </svg> Oct 26, 2021 </div> <div class="flex items-center gap-2"> <svg class="size-5 stroke-current"> <use href="/ui.svg#book-open"></use> </svg> 4 min read </div> </div> <h1 class="text-3xl font-semibold text-black dark:text-white mt-2"> Example how to analyze DynamoDB item changes with Kinesis and Athena created with CDK </h1> <div class="mt-1"> This post is how stream data changes of a DynamoDb table via Kinesis Data Stream and Kinesis Firehose to S3, and analyze the data with Athena. Build with CDK. </div> <!-- {(demoUrl || repoUrl) && 
  <div class="mt-4 flex flex-wrap gap-2">
    {demoUrl && 
      <a href={demoUrl} target="_blank" class="group flex gap-2 items-center px-3 py-1.5 truncate rounded text-xs md:text-sm lg:text-base border border-black/25 dark:border-white/25 hover:bg-black/5 hover:dark:bg-white/15 blend">
        <svg class="size-4">
          <use href="/ui.svg#globe" class="fill-current group-hover:fill-black group-hover:dark:fill-white blend"/>
        </svg>
        <span class="text-current group-hover:text-black group-hover:dark:text-white blend">
          See Demo
        </span>
      </a>
    }
    {repoUrl && 
      <a href={repoUrl} target="_blank" class="group flex gap-2 items-center px-3 py-1.5 truncate rounded text-xs md:text-sm lg:text-base border border-black/25 dark:border-white/25 hover:bg-black/5 hover:dark:bg-white/15 blend">
        <svg class="size-4">
          <use href="/ui.svg#link" class="fill-current group-hover:fill-black group-hover:dark:fill-white blend"/>
        </svg>
        <span class="text-current group-hover:text-black group-hover:dark:text-white blend">
          See Repository
        </span>
      </a>
    }
  </div> 
  } --> </div> </div>   </div> </div> <div class="flex-1 py-5"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">   <div class="animate"> <div> <article> <p>This is the same like described [here]({{ site.baseurl }}/aws/2021/08/27/aws_example_ddb_analytics/), but instead of terraform it’s build with <a href="https://aws.amazon.com/cdk/">CDK</a>.</p>
<p>To bootstrap the project run this command: <code>cdk init app --language typescript</code>
Further information are <a href="https://docs.aws.amazon.com/cdk/latest/guide/hello_world.html">here</a></p>
<p>All the services are in <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/cdk-stack.ts">this</a> file.</p>
<h2 id="updates">Updates</h2>
<p>2022-09-11: Add prefix for kinesis data firehose S3 destination
2022-08-13: CDK migrated to v2</p>
<h2 id="kms-key">KMS key</h2>
<p>This creates are KMS key with an alias to encrypt the data in the created services.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> kmsKey</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> kms.</span><span style="color:#B392F0">Key</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'kmsKey'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">      enableKeyRotation: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">kmsKey.</span><span style="color:#B392F0">addAlias</span><span style="color:#E1E4E8">(name)</span></span>
<span class="line"></span></code></pre>
<h2 id="dynamodb-and-kinesis-data-stream">DynamoDb and Kinesis Data Stream</h2>
<p>This is the creation of the DynamoDb with the Kinesis Data Stream.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> stream</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> kinesis.</span><span style="color:#B392F0">Stream</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Stream'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">      streamName: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-data-stream`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      encryption: kinesis.StreamEncryption.</span><span style="color:#79B8FF">KMS</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      encryptionKey: kmsKey,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> table</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> dynamodb.</span><span style="color:#B392F0">Table</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Table'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">      tableName: name,</span></span>
<span class="line"><span style="color:#E1E4E8">      partitionKey: { name: </span><span style="color:#9ECBFF">'pk'</span><span style="color:#E1E4E8">, type: dynamodb.AttributeType.</span><span style="color:#79B8FF">STRING</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">      billingMode: dynamodb.BillingMode.</span><span style="color:#79B8FF">PAY_PER_REQUEST</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      encryption: dynamodb.TableEncryption.</span><span style="color:#79B8FF">CUSTOMER_MANAGED</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      encryptionKey: kmsKey,</span></span>
<span class="line"><span style="color:#E1E4E8">      kinesisStream: stream,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span></code></pre>
<p>That adds to the DynamoDb, a Kinesis Data Stream, and connects it to the DynamoDb.</p>
<p>![kinesis data stream]({{ site.baseurl }}/img/2021-10-26-aws_example_ddb_analytics_cdk/kinesis_data_stream.png)</p>
<p>![kinesis data stream ddb]({{ site.baseurl }}/img/2021-10-26-aws_example_ddb_analytics_cdk/kinesis_data_stream_ddb.png)</p>
<h2 id="kinesis-data-firehose-and-s3-bucket">Kinesis Data Firehose and S3 Bucket</h2>
<p>Kinesis Data Firehose is the connection between the Kinesis Data Stream to the S3 Bucket.</p>
<p>Unfortunately, Firehose stores the JSONs without a linefeed. Therefore it’s a lambda for conversion is necessary.</p>
<p>More about that is described in this <a href="https://medium.com/analytics-vidhya/append-newline-to-amazon-kinesis-firehose-json-formatted-records-with-python-f58498d0177a">post</a></p>
<p>To have the kinesis firehose data isolated under a “namespace” we use a prefix.</p>
<p>It looks like this.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583"> const</span><span style="color:#79B8FF"> firehoseBucket</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> s3.</span><span style="color:#B392F0">Bucket</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'firehose-s3-bucket'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">      bucketName: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-firehose-s3-bucket`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      encryptionKey: kmsKey,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> processor</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> lambda.</span><span style="color:#B392F0">NodejsFunction</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'lambda-function-processor'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">  functionName: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-firehose-converter`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  timeout: cdk.Duration.</span><span style="color:#B392F0">minutes</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">  bundling: {</span></span>
<span class="line"><span style="color:#E1E4E8">    sourceMap: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> lambdaProcessor</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> LambdaFunctionProcessor</span><span style="color:#E1E4E8">(processor, {</span></span>
<span class="line"><span style="color:#E1E4E8">  retries: </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> ddbChangesPrefix</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'ddb-changes'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> s3Destination</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> destinations.</span><span style="color:#B392F0">S3Bucket</span><span style="color:#E1E4E8">(firehoseBucket, {</span></span>
<span class="line"><span style="color:#E1E4E8">  encryptionKey: kmsKey,</span></span>
<span class="line"><span style="color:#E1E4E8">  bufferingInterval: cdk.Duration.</span><span style="color:#B392F0">seconds</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">60</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">  processor: lambdaProcessor,</span></span>
<span class="line"><span style="color:#E1E4E8">  dataOutputPrefix: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">ddbChangesPrefix</span><span style="color:#9ECBFF">}/`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> firehoseDeliveryStream</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> firehose.</span><span style="color:#B392F0">DeliveryStream</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Delivery Stream'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">  deliveryStreamName: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-firehose`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  sourceStream: stream,</span></span>
<span class="line"><span style="color:#E1E4E8">  destinations: [s3Destination],</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<p>The delivery of the data to the S3 bucket is buffered. Here are the default values.</p>
<p>![firehose-buffer]({{ site.baseurl }}/img/2021-10-26-aws_example_ddb_analytics_cdk/firehose_buffer.png)</p>
<h2 id="glue-crawler">Glue crawler</h2>
<p>Athena needs a structured table for the SQL queries. The Glue crawler creates this from the data in the S3 bucket below the configured prefix.</p>
<p>The glue crawler isn’t a L2 construct yet. So it needs a L1 construct. See <a href="https://blog.phillipninan.com/a-no-nonsense-guide-to-aws-cloud-development-kit-cdk">here</a> more about L1 - L3.</p>
<p>There is already a <a href="https://github.com/aws/aws-cdk/issues/8863">github issue</a> to create a L2 construct for the glue crawler.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> getSecurityConfiguration</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> iam.</span><span style="color:#B392F0">PolicyDocument</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      statements: [</span></span>
<span class="line"><span style="color:#F97583">        new</span><span style="color:#E1E4E8"> iam.</span><span style="color:#B392F0">PolicyStatement</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">          actions: [</span><span style="color:#9ECBFF">'glue:GetSecurityConfiguration'</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">          resources: [</span><span style="color:#9ECBFF">'*'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">        })</span></span>
<span class="line"><span style="color:#E1E4E8">      ]</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> roleCrawler</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> iam.</span><span style="color:#B392F0">Role</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'role crawler'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">    roleName: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-crawler-role`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    assumedBy: </span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> iam.</span><span style="color:#B392F0">ServicePrincipal</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'glue.amazonaws.com'</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    inlinePolicies: {</span></span>
<span class="line"><span style="color:#E1E4E8">      GetSecurityConfiguration: getSecurityConfiguration</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> glueDb</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> glue.</span><span style="color:#B392F0">Database</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'glue db'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">    databaseName: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-db`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> glueSecurityOptions</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> glue.</span><span style="color:#B392F0">SecurityConfiguration</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'glue security options'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">    securityConfigurationName: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-security-options`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    s3Encryption: {</span></span>
<span class="line"><span style="color:#E1E4E8">      mode: glue.S3EncryptionMode.</span><span style="color:#79B8FF">KMS</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> crawler</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> glue.</span><span style="color:#B392F0">CfnCrawler</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'crawler'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">    name: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-crawler`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    role: roleCrawler.roleArn,</span></span>
<span class="line"><span style="color:#E1E4E8">    targets: {</span></span>
<span class="line"><span style="color:#E1E4E8">      s3Targets: [</span></span>
<span class="line"><span style="color:#E1E4E8">        {</span></span>
<span class="line"><span style="color:#E1E4E8">          path: </span><span style="color:#9ECBFF">`s3://${</span><span style="color:#E1E4E8">firehoseBucket</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">bucketName</span><span style="color:#9ECBFF">}/${</span><span style="color:#E1E4E8">ddbChangesPrefix</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">      ],</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    databaseName: glueDb.databaseName,</span></span>
<span class="line"><span style="color:#E1E4E8">    crawlerSecurityConfiguration: glueSecurityOptions.securityConfigurationName,</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // const glueCrawlerLogArn = `arn:aws:logs:${cdk.Stack.of(this).region}:${cdk.Stack.of(this).account}:log-group:/aws-glue/crawlers:log-stream:${crawler.name}`</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> glueCrawlerLogArn</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> `arn:aws:logs:${</span><span style="color:#E1E4E8">cdk</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">Stack</span><span style="color:#9ECBFF">.</span><span style="color:#B392F0">of</span><span style="color:#9ECBFF">(</span><span style="color:#79B8FF">this</span><span style="color:#9ECBFF">).</span><span style="color:#E1E4E8">region</span><span style="color:#9ECBFF">}:${</span><span style="color:#E1E4E8">cdk</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">Stack</span><span style="color:#9ECBFF">.</span><span style="color:#B392F0">of</span><span style="color:#9ECBFF">(</span><span style="color:#79B8FF">this</span><span style="color:#9ECBFF">).</span><span style="color:#E1E4E8">account</span><span style="color:#9ECBFF">}:log-group:/aws-glue/crawlers*`</span><span style="color:#6A737D"> //:log-stream:${crawler.name}`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> glueTableArn</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> `arn:aws:glue:${</span><span style="color:#E1E4E8">cdk</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">Stack</span><span style="color:#9ECBFF">.</span><span style="color:#B392F0">of</span><span style="color:#9ECBFF">(</span><span style="color:#79B8FF">this</span><span style="color:#9ECBFF">).</span><span style="color:#E1E4E8">region</span><span style="color:#9ECBFF">}:${</span><span style="color:#E1E4E8">cdk</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">Stack</span><span style="color:#9ECBFF">.</span><span style="color:#B392F0">of</span><span style="color:#9ECBFF">(</span><span style="color:#79B8FF">this</span><span style="color:#9ECBFF">).</span><span style="color:#E1E4E8">account</span><span style="color:#9ECBFF">}:table/${</span><span style="color:#E1E4E8">glueDb</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">databaseName</span><span style="color:#9ECBFF">}/*`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> glueCrawlerArn</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> `arn:aws:glue:${</span><span style="color:#E1E4E8">cdk</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">Stack</span><span style="color:#9ECBFF">.</span><span style="color:#B392F0">of</span><span style="color:#9ECBFF">(</span><span style="color:#79B8FF">this</span><span style="color:#9ECBFF">).</span><span style="color:#E1E4E8">region</span><span style="color:#9ECBFF">}:${</span><span style="color:#E1E4E8">cdk</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">Stack</span><span style="color:#9ECBFF">.</span><span style="color:#B392F0">of</span><span style="color:#9ECBFF">(</span><span style="color:#79B8FF">this</span><span style="color:#9ECBFF">).</span><span style="color:#E1E4E8">account</span><span style="color:#9ECBFF">}:crawler/${</span><span style="color:#E1E4E8">crawler</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  roleCrawler.</span><span style="color:#B392F0">addToPolicy</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">    new</span><span style="color:#E1E4E8"> iam.</span><span style="color:#B392F0">PolicyStatement</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      resources: [</span></span>
<span class="line"><span style="color:#E1E4E8">        glueCrawlerLogArn,</span></span>
<span class="line"><span style="color:#E1E4E8">        glueTableArn,</span></span>
<span class="line"><span style="color:#E1E4E8">        glueDb.catalogArn,</span></span>
<span class="line"><span style="color:#E1E4E8">        glueDb.databaseArn,</span></span>
<span class="line"><span style="color:#E1E4E8">        kmsKey.keyArn,</span></span>
<span class="line"><span style="color:#E1E4E8">        firehoseBucket.bucketArn,</span></span>
<span class="line"><span style="color:#9ECBFF">        `${</span><span style="color:#E1E4E8">firehoseBucket</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">bucketArn</span><span style="color:#9ECBFF">}/*`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        glueCrawlerArn,</span></span>
<span class="line"><span style="color:#E1E4E8">      ],</span></span>
<span class="line"><span style="color:#E1E4E8">      actions: [</span><span style="color:#9ECBFF">'logs:*'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'glue:*'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'kms:*'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'S3:*'</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span></span>
<span class="line"></span></code></pre>
<p>For test purposes, it’s enough to run the crawler before any analysis. Scheduling is also possible.</p>
<p>![glue-run-crawler]({{ site.baseurl }}/img/2021-10-26-aws_example_ddb_analytics_cdk/glue_run_crawler.png)</p>
<p>That creates this table, which is accessible by Athena.</p>
<p>![glue-table]({{ site.baseurl }}/img/2021-10-26-aws_example_ddb_analytics_cdk/glue_table.png)</p>
<h2 id="athena">Athena</h2>
<p>For Athena it needs an S3 bucket for the query results and, for better isolation to other projects, a workgroup.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> athenaQueryResults</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> s3.</span><span style="color:#B392F0">Bucket</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'query-results'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">      bucketName: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-query-results`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      encryptionKey: kmsKey,</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">new</span><span style="color:#E1E4E8"> athena.</span><span style="color:#B392F0">CfnWorkGroup</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'analytics-athena-workgroup'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">  name: </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">name</span><span style="color:#9ECBFF">}-workgroup`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  workGroupConfiguration: {</span></span>
<span class="line"><span style="color:#E1E4E8">    resultConfiguration: {</span></span>
<span class="line"><span style="color:#E1E4E8">      outputLocation: </span><span style="color:#9ECBFF">`s3://${</span><span style="color:#E1E4E8">athenaQueryResults</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">bucketName</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      encryptionConfiguration: {</span></span>
<span class="line"><span style="color:#E1E4E8">        encryptionOption: </span><span style="color:#9ECBFF">'SSE_KMS'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        kmsKey: kmsKey.keyArn,</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span>
<span class="line"></span></code></pre>
<p>How to anylyze the data see also [here]({{ site.baseurl }}/aws/2021/08/27/aws_example_ddb_analytics/)</p>
<h2 id="cost-alert">Cost Alert 💰</h2>
<p>⚠️ Don’t forget to destroy after testing. Kinesis Data Streams has <a href="https://aws.amazon.com/kinesis/data-streams/pricing/">costs</a> per hour</p>
<h2 id="code">Code</h2>
<p><a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk">https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk</a></p> </article> <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"> <a href="/blog/2022-08-22-aws_example_ddb_analytics_athena_saved_queries_cdk" class="group p-4 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 blend"> <div class="order-2 w-full h-full group-hover:text-black group-hover:dark:text-white blend"> <div class="flex flex-wrap gap-2"> <div class="text-sm uppercase">
Prev
</div> </div> <div class="font-semibold mt-3 text-black dark:text-white"> Example how to create Athena saved queries with CDK </div> </div> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="order-1 stroke-current group-hover:stroke-black group-hover:dark:stroke-white rotate-180"> <line x1="5" y1="12" x2="19" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-4 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></line> <polyline points="12 5 19 12 12 19" class="translate-x-0 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></polyline> </svg> </a> <a href="/blog/2021-08-27-aws_example_ddb_analytics" class="group p-4 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"> <div class="w-full h-full text-right group-hover:text-black group-hover:dark:text-white blend"> <div class="text-sm uppercase">
Next
</div> <div class="font-semibold mt-3 text-black dark:text-white"> Example how to analyze DynamoDB item changes with Kinesis and Athena created with Terraform </div> </div> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white"> <line x1="5" y1="12" x2="19" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-4 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></line> <polyline points="12 5 19 12 12 19" class="translate-x-0 group-hover:translate-x-1 transition-all duration-300 ease-in-out"></polyline> </svg> </a> </div> </div> </div>   </div> </div>  </main> <footer class="relative bg-white dark:bg-black"> <div class="animate"> <section class="py-5"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">  <div class="flex items-center justify-center sm:justify-end"> <button id="back-to-top" aria-label="Back to top of page" class="group flex w-fit p-1.5 gap-1.5 text-sm items-center border rounded hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-colors duration-300 ease-in-out"> <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="stroke-current group-hover:stroke-black group-hover:dark:stroke-white rotate-90"> <line x1="19" y1="12" x2="5" y2="12" class="scale-x-0 group-hover:scale-x-100 translate-x-3 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></line> <polyline points="12 19 5 12 12 5" class="translate-x-1 group-hover:translate-x-0 transition-all duration-300 ease-in-out"></polyline> </svg> <div class="w-full group-hover:text-black group-hover:dark:text-white transition-colors duration-300 ease-in-out">
Back to top
</div> </button> </div>  </div> </section> <section class="py-5 overflow-hidden whitespace-nowrap border-t border-black/10 dark:border-white/25"> <div class="w-full h-full mx-auto px-5 max-w-screen-md">  <div class="h-full grid grid-cols-1 sm:grid-cols-2 gap-3"> <div class="order-2 sm:order-1 flex flex-col items-center justify-center sm:items-start"> <div class="legal"> <a href="/legal/terms" class="text-current hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out">
Terms
</a> |
<a href="/legal/privacy" class="text-current hover:text-black dark:hover:text-white transition-colors duration-300 ease-in-out">
Privacy
</a> </div> <div class="text-sm mt-2">&copy; 2024 | All rights reserved</div> </div> <div class="order-1 sm:order-2 flex justify-center sm:justify-end"> <div class="flex flex-wrap gap-1 items-center justify-center"> <!-- {
                SOCIALS.map((SOCIAL) => (
                  <a 
                    href={SOCIAL.HREF} 
                    target="_blank" 
                    aria-label={`${SITE.TITLE} on ${SOCIAL.NAME}`} 
                    class="group size-10 rounded-full p-2 items-center justify-center hover:bg-black/5 dark:hover:bg-white/20  blend"
                  >
                    <svg class="size-full fill-current group-hover:fill-black group-hover:dark:fill-white blend">
                      <use href={`/social.svg#${SOCIAL.ICON}`} />
                    </svg>
                  </a>
                ))
              } --> <a href="https://github.com/JohannesKonings/JohannesKonings.github.io" target="_blank" aria-label="GitHub repo" class="group size-10 rounded-full p-2 items-center justify-center hover:bg-black/5 dark:hover:bg-white/20 blend"> <svg class="size-full fill-current group-hover:fill-black group-hover:dark:fill-white blend"> <use href="/social.svg#github"></use> </svg> </a> </div> </div> </div>  </div> </section> </div> </footer> <script>
  function goBackToTop(event) {
    event.preventDefault();
    window.scrollTo({
      top: 0,
      behavior: "smooth",
    });
  }

  function inintializeBackToTop() {
    const backToTop = document.getElementById("back-to-top");
    backToTop?.addEventListener("click", goBackToTop);
  }

  document.addEventListener("astro:after-swap", inintializeBackToTop);
  inintializeBackToTop();
</script> </body></html>
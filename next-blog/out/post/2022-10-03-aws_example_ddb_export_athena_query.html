<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/next-blog/out/_next/static/css/66c48826d6382dcb.css" as="style" crossorigin=""/><link rel="stylesheet" href="/next-blog/out/_next/static/css/66c48826d6382dcb.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/next-blog/out/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/next-blog/out/_next/static/chunks/webpack-7af3f00e54ee1119.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/framework-5429a50ba5373c56.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/main-def68a4901fa3cc6.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/pages/_app-a5ae041df49b62a0.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/56-99b6b0e6945aba0d.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/pages/post/%5Bslug%5D-c07d00169c09ab18.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/2zVoAH4240IV3odeQrveE/_buildManifest.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/2zVoAH4240IV3odeQrveE/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen"><header class="bg-fuchsia-100 mb-8 py-4"><div class="container mx-auto flex justify-center"><a href="/next-blog/out">üè°</a><span class="mx-auto">Welcome to my blog</span> </div></header><main class="container mx-auto flex-1"><div><div class="prose mx-auto"><h1>Example how to trigger a Dynamodb export and create an Athena saved query with CDK</h1><div><p>In [this]({{ site.baseurl }}/aws/2021/08/27/aws_example_ddb_analytics_cdk/) post is described how to get the data to analyze the changes in the dynamodb data. This post describes how to (semi) automate the export of the dynamodb table data and analyze it with Athena. <a href="https://aws.amazon.com/de/blogs/aws/new-export-amazon-dynamodb-table-data-to-data-lake-amazon-s3/">This</a> post describes how you can do that manually.</p>
<p>One approach is with a lambda and another approach is with step functions. Both approaches implement the steps for triggering the export to a S3 bucket, create an athena table for that exported data and prepare a namend query for analyzing.</p>
<p>The data for this example looks like this.</p>
<p>![ddb export ddb data]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-ddb-data.png)</p>
<h2>With lambda</h2>
<p><a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/ddb-export.lambda-function-ddb-export.ts">This lambda</a> triggers the export with via the sdk and create or update a named query.</p>
<p><a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/createTable.sql">The query</a> creates the athena table. The export id will be set by the lambda by replacing the &quot;s3location&quot; with something like <code>s3://&lt;&lt;bucket name&gt;&gt;/ddb-exports/AWSDynamoDB/&lt;&lt;ddb-export-id&gt;&gt;/data/</code>.</p>
<pre><code class="language-SQL">CREATE EXTERNAL TABLE ddb_exported_table (
 Item struct&lt;pk:struct&lt;S:string&gt;,
             person:struct&lt;M:struct&lt;
                jobArea:struct&lt;S:string&gt;,
                firstname:struct&lt;S:string&gt;,
                gender:struct&lt;S:string&gt;,
                jobType:struct&lt;S:string&gt;,
                jobDescriptor:struct&lt;S:string&gt;,
                lastname:struct&lt;S:string&gt;
                &gt;&gt;&gt;
)
ROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'
LOCATION 's3Location'
TBLPROPERTIES ( 'has_encrypted_data'='true');
</code></pre>
<p>https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/readTable.sql</p>
<pre><code class="language-SQL">SELECT 
item.pk.S as pk,
item.person.M.firstname.S as firstname,
item.person.M.lastname.S as lastname,
item.person.M.jobArea.S as jobArea,
item.person.M.gender.S as gender, 
item.person.M.jobType.S as jobType, 
item.person.M.jobDescriptor.S as jobDescriptor
FROM &quot;db_name&quot;.&quot;table_name&quot;;
</code></pre>
<p>After you started the lambda you have to wait until the export is finished. Then you can run the query for creating the athena table. The lambda has already deleted the old table. After that you can use the prepared query for analyzing.</p>
<p>A more orchestrated approach is with step function. That's better for waiting for the results :)</p>
<h2>With step functions</h2>
<p>This are the steps, which are orchestrated by the step function.</p>
<p>![ddb export sfn]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn.png)</p>
<p>It's definend <a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/ddb-export-step-function.ts">here</a></p>
<p>The step function could be startet with the default values.</p>
<p>![ddb export sfn start 1]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-start-1.png)</p>
<p>![ddb export sfn start 2]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-start-2.png)</p>
<p>It takes some minutes to complete.</p>
<p>![ddb export sfn run]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-run.png)</p>
<p>The &quot;recent queries&quot; section list the steps for dropping the old table and create the new one.</p>
<p>![ddb export sfn athena recent queries]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-athena-recent-queries.png)</p>
<p>After it's finished you can choose the saved query with the name <code>sfn-ddb-export-read-table</code>. It can be used to query all the data from the dynamodb table and could be adapted to more &quot;complex&quot; queries.</p>
<p>![ddb export sfn athena query]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-athena-query.png)</p>
<h2>Code</h2>
<p><a href="https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk">https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk</a></p>
</div></div></div></main><footer class="bg-fuchsia-100 mt-8 py-4"><div class="container mx-auto flex justify-center"><a href="/next-blog/out/impressum">Impressum</a></div><div class="container mx-auto flex justify-center">&lt;/&gt; on <a href="https://github.com/JohannesKonings/JohannesKonings.github.io">Github</a> ¬†<i class="fa fa-github-alt"></i></div></footer></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"frontmatter":{"layout":"post","title":"Example how to trigger a Dynamodb export and create an Athena saved query with CDK","date":"2022-10-03 08:15:18","published":true,"summary":"This post is how to trigger a Dynamodb export and create saved query to create a Athena table from the exported data","categories":"aws","thumbnail":"aws_athena","tags":["aws","aws athena","aws cdk","aws dynamodb"]},"content":"\nIn [this]({{ site.baseurl }}/aws/2021/08/27/aws_example_ddb_analytics_cdk/) post is described how to get the data to analyze the changes in the dynamodb data. This post describes how to (semi) automate the export of the dynamodb table data and analyze it with Athena. [This](https://aws.amazon.com/de/blogs/aws/new-export-amazon-dynamodb-table-data-to-data-lake-amazon-s3/) post describes how you can do that manually. \n\nOne approach is with a lambda and another approach is with step functions. Both approaches implement the steps for triggering the export to a S3 bucket, create an athena table for that exported data and prepare a namend query for analyzing.\n\nThe data for this example looks like this.\n\n![ddb export ddb data]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-ddb-data.png)\n\n\n## With lambda\n\n[This lambda](https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/ddb-export.lambda-function-ddb-export.ts) triggers the export with via the sdk and create or update a named query.\n\n[The query](https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/createTable.sql) creates the athena table. The export id will be set by the lambda by replacing the \"s3location\" with something like `s3://\u003c\u003cbucket name\u003e\u003e/ddb-exports/AWSDynamoDB/\u003c\u003cddb-export-id\u003e\u003e/data/`.\n\n```SQL\nCREATE EXTERNAL TABLE ddb_exported_table (\n Item struct\u003cpk:struct\u003cS:string\u003e,\n             person:struct\u003cM:struct\u003c\n                jobArea:struct\u003cS:string\u003e,\n                firstname:struct\u003cS:string\u003e,\n                gender:struct\u003cS:string\u003e,\n                jobType:struct\u003cS:string\u003e,\n                jobDescriptor:struct\u003cS:string\u003e,\n                lastname:struct\u003cS:string\u003e\n                \u003e\u003e\u003e\n)\nROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'\nLOCATION 's3Location'\nTBLPROPERTIES ( 'has_encrypted_data'='true');\n```\n\nhttps://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/readTable.sql\n\n```SQL\nSELECT \nitem.pk.S as pk,\nitem.person.M.firstname.S as firstname,\nitem.person.M.lastname.S as lastname,\nitem.person.M.jobArea.S as jobArea,\nitem.person.M.gender.S as gender, \nitem.person.M.jobType.S as jobType, \nitem.person.M.jobDescriptor.S as jobDescriptor\nFROM \"db_name\".\"table_name\";\n```\n\nAfter you started the lambda you have to wait until the export is finished. Then you can run the query for creating the athena table. The lambda has already deleted the old table. After that you can use the prepared query for analyzing.\n\nA more orchestrated approach is with step function. That's better for waiting for the results :)\n\n## With step functions\n\nThis are the steps, which are orchestrated by the step function. \n\n![ddb export sfn]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn.png)\n\nIt's definend [here](https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/ddb-export-step-function.ts)\n\nThe step function could be startet with the default values.\n\n![ddb export sfn start 1]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-start-1.png)\n\n![ddb export sfn start 2]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-start-2.png)\n\nIt takes some minutes to complete.\n\n![ddb export sfn run]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-run.png)\n\nThe \"recent queries\" section list the steps for dropping the old table and create the new one.\n\n![ddb export sfn athena recent queries]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-athena-recent-queries.png)\n\nAfter it's finished you can choose the saved query with the name `sfn-ddb-export-read-table`. It can be used to query all the data from the dynamodb table and could be adapted to more \"complex\" queries.\n\n![ddb export sfn athena query]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-athena-query.png)\n\n\n## Code\n\n[https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk](https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk)\n\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2022-10-03-aws_example_ddb_export_athena_query"},"buildId":"2zVoAH4240IV3odeQrveE","assetPrefix":"/next-blog/out","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
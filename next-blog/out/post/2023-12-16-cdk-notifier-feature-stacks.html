<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/next-blog/out/_next/static/css/66c48826d6382dcb.css" as="style" crossorigin=""/><link rel="stylesheet" href="/next-blog/out/_next/static/css/66c48826d6382dcb.css" crossorigin="" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" crossorigin="" nomodule="" src="/next-blog/out/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/next-blog/out/_next/static/chunks/webpack-7af3f00e54ee1119.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/framework-5429a50ba5373c56.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/main-def68a4901fa3cc6.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/pages/_app-a5ae041df49b62a0.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/56-99b6b0e6945aba0d.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/chunks/pages/post/%5Bslug%5D-c07d00169c09ab18.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/2zVoAH4240IV3odeQrveE/_buildManifest.js" defer="" crossorigin=""></script><script src="/next-blog/out/_next/static/2zVoAH4240IV3odeQrveE/_ssgManifest.js" defer="" crossorigin=""></script></head><body><div id="__next"><div class="flex flex-col min-h-screen"><header class="bg-fuchsia-100 mb-8 py-4"><div class="container mx-auto flex justify-center"><a href="/next-blog/out">üè°</a><span class="mx-auto">Welcome to my blog</span> </div></header><main class="container mx-auto flex-1"><div><div class="prose mx-auto"><h1>Use cdk-notifier to compare changes in pull requests</h1><div><h2>Use case</h2>
<p>Especially in serverless environments, features will be created with ephemeral stacks, which will be deleted after merging to the main branch. Comparing the cdk diff between the feature branch and the main branch will help to understand which changes will be applied after merging the pull request.</p>
<p>Some changes, like renaming a dynamodb table or updating more than one dynamodb index, will work if the changes are made before deploying the feature stack but fail if the changes are applied to an existing stack.</p>
<p>The cdk-notifer will help to identify these changes.</p>
<h2>cdk-notifier</h2>
<p>See here for more information about the cdk-notifier:
<a href="https://github.com/karlderkaefer/cdk-notifier">https://github.com/karlderkaefer/cdk-notifier</a></p>
<h2>GitHub Action</h2>
<p>This setting has a deployed stack from the main branch, for the feature development a new branch <code>feat1</code> is created and deployed as a new stack.</p>
<p>![stack-overview]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/stack-overview.png)</p>
<p>In the pull request the cdk-notifier action is added to the workflow and create a diff from the <code>feat1</code> branch files with the BRANCH_NAME env variable for <code>main</code> to run the diff agianst the <code>main</code> stack.
The diff output will be added to the pull request as a comment via the cdk-notifier.</p>
<pre><code class="language-yaml">      - name: Check diff to main
        run: |
          npm ci  
          echo &quot;check the diff to main&quot;
          BRANCH_NAME=main npx cdk diff --app cdk.out --progress=events &amp;&gt; &gt;(tee cdk.log)
          echo &quot;create cdk-notifier report&quot;
          echo &quot;BRANCH_NAME: $BRANCH_NAME&quot;
          echo &quot;GITHUB_OWNER: $GITHUB_OWNER&quot;
          echo &quot;GITHUB_REPO: $GITHUB_REPO&quot;
          cdk-notifier \
          --owner ${{ env.GITHUB_OWNER }} \
          --repo ${{ env.GITHUB_REPO }} \
          --token ${{ secrets.GITHUB_TOKEN }} \
          --log-file ./cdk.log \
          --tag-id diff-to-main \
          --pull-request-id ${{ env.PULL_REQUEST_ID }} \
          --vcs github \
          --ci circleci \
          --template extendedWithResources
</code></pre>
<p><a href="https://github.com/JohannesKonings/cdk-notifier-examples/blob/main/.github/workflows/cdk-diff.yml">https://github.com/JohannesKonings/cdk-notifier-examples/blob/main/.github/workflows/cdk-diff.yml</a></p>
<p>![pipeline in pull request]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/pipeline-in-pull-request.png)</p>
<p>The comment looks like this:</p>
<p>![PR comment]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/pr-comment.png)
<a href="https://github.com/JohannesKonings/cdk-notifier-examples/pull/4#issuecomment-1858909147">https://github.com/JohannesKonings/cdk-notifier-examples/pull/4#issuecomment-1858909147</a></p>
<p>The extended template parameter of the cdk-notifier displays in this setting also a warning that the dynamodb requires a replacement.
In some cases, this could be unintended and be reverted securely in the feature branch before merging.
That is a nice feature besides the overview of the changes, which is itself helpful in making these changes more visible.</p>
<p>After the merge, the feature stack will be destroyed, and the main stack will be updated.</p>
<p>![pipeline after merge]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/pipeline-after-merge.png)</p>
<h2>Code</h2>
<p><a href="https://github.com/JohannesKonings/cdk-notifier-examples">https://github.com/JohannesKonings/cdk-notifier-examples</a></p>
</div></div></div></main><footer class="bg-fuchsia-100 mt-8 py-4"><div class="container mx-auto flex justify-center"><a href="/next-blog/out/impressum">Impressum</a></div><div class="container mx-auto flex justify-center">&lt;/&gt; on <a href="https://github.com/JohannesKonings/JohannesKonings.github.io">Github</a> ¬†<i class="fa fa-github-alt"></i></div></footer></div></div><script id="__NEXT_DATA__" type="application/json" crossorigin="">{"props":{"pageProps":{"frontmatter":{"layout":"post","title":"Use cdk-notifier to compare changes in pull requests","date":"2023-12-16 08:15:18","published":true,"summary":"See how cdk-notifier can help to compare which cdk changes will be applied after merging a pull request","categories":"aws","thumbnail":"cdk","tags":["aws","cdk","cdk-notifier"]},"content":"\n## Use case\n\nEspecially in serverless environments, features will be created with ephemeral stacks, which will be deleted after merging to the main branch. Comparing the cdk diff between the feature branch and the main branch will help to understand which changes will be applied after merging the pull request.\n\nSome changes, like renaming a dynamodb table or updating more than one dynamodb index, will work if the changes are made before deploying the feature stack but fail if the changes are applied to an existing stack.\n\nThe cdk-notifer will help to identify these changes.\n\n## cdk-notifier\n\nSee here for more information about the cdk-notifier:\n[https://github.com/karlderkaefer/cdk-notifier](https://github.com/karlderkaefer/cdk-notifier)\n\n## GitHub Action\n\nThis setting has a deployed stack from the main branch, for the feature development a new branch `feat1` is created and deployed as a new stack.\n\n![stack-overview]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/stack-overview.png)\n\nIn the pull request the cdk-notifier action is added to the workflow and create a diff from the `feat1` branch files with the BRANCH_NAME env variable for `main` to run the diff agianst the `main` stack.\nThe diff output will be added to the pull request as a comment via the cdk-notifier.\n\n```yaml\n      - name: Check diff to main\n        run: |\n          npm ci  \n          echo \"check the diff to main\"\n          BRANCH_NAME=main npx cdk diff --app cdk.out --progress=events \u0026\u003e \u003e(tee cdk.log)\n          echo \"create cdk-notifier report\"\n          echo \"BRANCH_NAME: $BRANCH_NAME\"\n          echo \"GITHUB_OWNER: $GITHUB_OWNER\"\n          echo \"GITHUB_REPO: $GITHUB_REPO\"\n          cdk-notifier \\\n          --owner ${{ env.GITHUB_OWNER }} \\\n          --repo ${{ env.GITHUB_REPO }} \\\n          --token ${{ secrets.GITHUB_TOKEN }} \\\n          --log-file ./cdk.log \\\n          --tag-id diff-to-main \\\n          --pull-request-id ${{ env.PULL_REQUEST_ID }} \\\n          --vcs github \\\n          --ci circleci \\\n          --template extendedWithResources\n```\n[https://github.com/JohannesKonings/cdk-notifier-examples/blob/main/.github/workflows/cdk-diff.yml](https://github.com/JohannesKonings/cdk-notifier-examples/blob/main/.github/workflows/cdk-diff.yml)\n\n![pipeline in pull request]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/pipeline-in-pull-request.png)\n\nThe comment looks like this:\n\n![PR comment]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/pr-comment.png)\n[https://github.com/JohannesKonings/cdk-notifier-examples/pull/4#issuecomment-1858909147](https://github.com/JohannesKonings/cdk-notifier-examples/pull/4#issuecomment-1858909147)\n\nThe extended template parameter of the cdk-notifier displays in this setting also a warning that the dynamodb requires a replacement.\nIn some cases, this could be unintended and be reverted securely in the feature branch before merging.\nThat is a nice feature besides the overview of the changes, which is itself helpful in making these changes more visible.\n\nAfter the merge, the feature stack will be destroyed, and the main stack will be updated.\n\n![pipeline after merge]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/pipeline-after-merge.png)\n\n\n## Code\n\n[https://github.com/JohannesKonings/cdk-notifier-examples](https://github.com/JohannesKonings/cdk-notifier-examples)\n\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2023-12-16-cdk-notifier-feature-stacks"},"buildId":"2zVoAH4240IV3odeQrveE","assetPrefix":"/next-blog/out","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
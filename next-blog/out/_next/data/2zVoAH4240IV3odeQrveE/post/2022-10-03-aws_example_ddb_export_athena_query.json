{"pageProps":{"frontmatter":{"layout":"post","title":"Example how to trigger a Dynamodb export and create an Athena saved query with CDK","date":"2022-10-03 08:15:18","published":true,"summary":"This post is how to trigger a Dynamodb export and create saved query to create a Athena table from the exported data","categories":"aws","thumbnail":"aws_athena","tags":["aws","aws athena","aws cdk","aws dynamodb"]},"content":"\nIn [this]({{ site.baseurl }}/aws/2021/08/27/aws_example_ddb_analytics_cdk/) post is described how to get the data to analyze the changes in the dynamodb data. This post describes how to (semi) automate the export of the dynamodb table data and analyze it with Athena. [This](https://aws.amazon.com/de/blogs/aws/new-export-amazon-dynamodb-table-data-to-data-lake-amazon-s3/) post describes how you can do that manually. \n\nOne approach is with a lambda and another approach is with step functions. Both approaches implement the steps for triggering the export to a S3 bucket, create an athena table for that exported data and prepare a namend query for analyzing.\n\nThe data for this example looks like this.\n\n![ddb export ddb data]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-ddb-data.png)\n\n\n## With lambda\n\n[This lambda](https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/ddb-export.lambda-function-ddb-export.ts) triggers the export with via the sdk and create or update a named query.\n\n[The query](https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/createTable.sql) creates the athena table. The export id will be set by the lambda by replacing the \"s3location\" with something like `s3://<<bucket name>>/ddb-exports/AWSDynamoDB/<<ddb-export-id>>/data/`.\n\n```SQL\nCREATE EXTERNAL TABLE ddb_exported_table (\n Item struct<pk:struct<S:string>,\n             person:struct<M:struct<\n                jobArea:struct<S:string>,\n                firstname:struct<S:string>,\n                gender:struct<S:string>,\n                jobType:struct<S:string>,\n                jobDescriptor:struct<S:string>,\n                lastname:struct<S:string>\n                >>>\n)\nROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'\nLOCATION 's3Location'\nTBLPROPERTIES ( 'has_encrypted_data'='true');\n```\n\nhttps://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/readTable.sql\n\n```SQL\nSELECT \nitem.pk.S as pk,\nitem.person.M.firstname.S as firstname,\nitem.person.M.lastname.S as lastname,\nitem.person.M.jobArea.S as jobArea,\nitem.person.M.gender.S as gender, \nitem.person.M.jobType.S as jobType, \nitem.person.M.jobDescriptor.S as jobDescriptor\nFROM \"db_name\".\"table_name\";\n```\n\nAfter you started the lambda you have to wait until the export is finished. Then you can run the query for creating the athena table. The lambda has already deleted the old table. After that you can use the prepared query for analyzing.\n\nA more orchestrated approach is with step function. That's better for waiting for the results :)\n\n## With step functions\n\nThis are the steps, which are orchestrated by the step function. \n\n![ddb export sfn]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn.png)\n\nIt's definend [here](https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk/blob/main/cdk/lib/ddb-export/ddb-export-step-function.ts)\n\nThe step function could be startet with the default values.\n\n![ddb export sfn start 1]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-start-1.png)\n\n![ddb export sfn start 2]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-start-2.png)\n\nIt takes some minutes to complete.\n\n![ddb export sfn run]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-run.png)\n\nThe \"recent queries\" section list the steps for dropping the old table and create the new one.\n\n![ddb export sfn athena recent queries]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-athena-recent-queries.png)\n\nAfter it's finished you can choose the saved query with the name `sfn-ddb-export-read-table`. It can be used to query all the data from the dynamodb table and could be adapted to more \"complex\" queries.\n\n![ddb export sfn athena query]({{ site.baseurl }}/img/2022-10-03-aws_example_ddb_export_athena_query/ddb-export-sfn-athena-query.png)\n\n\n## Code\n\n[https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk](https://github.com/JohannesKonings/test-aws-dynamodb-athena-cdk)\n\n"},"__N_SSG":true}
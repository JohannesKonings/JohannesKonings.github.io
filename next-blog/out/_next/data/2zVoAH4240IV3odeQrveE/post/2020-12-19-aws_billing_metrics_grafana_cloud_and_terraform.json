{"pageProps":{"frontmatter":{"layout":"post","title":"How to setup AWS Billing metrics in Grafana Cloud via Terraform","date":"2020-12-19 08:15:18","published":true,"summary":"Terraform setup to display AWS billing metrics in Grafana Cloud with S3 Backend and CI/CD pipeline","categories":"aws","thumbnail":"terraform","tags":["aws","grafana","terraform"]},"content":"\n# Why Terraform?\n\nIn this [post]({{ site.baseurl }}/aws/2020/11/27/aws_billing_metrics_and_grafana_cloud/) I described how to display AWS Billing metrics in Grafana Cloud. Therefore it was necessary to create manually the data source and the dashboard.\nWith Terraform, you can describe the setup as code and benefit from the full advantages of [IaC](https://en.wikipedia.org/wiki/Infrastructure_as_code).\n\n# Terraform\n\n[Terraform](https://www.terraform.io/) is a tool for infrastructure as code and works with many different [provider](https://www.terraform.io/docs/providers/index.html#lists-of-terraform-providers).\nTerraform comes with a CLI for the deployments. \n\n# Grafana Provider and Dashboard declaration\n\nFor this use case, you need a Grafana data source and a Grafana dashboard. These configurations have to defined in a .tf file like this [one](https://github.com/JohannesKonings/aws-grafana-billing-dashboard/blob/main/grafana.tf)\n\nAt first the [provider](https://registry.terraform.io/providers/grafana/grafana/latest/docs).\n\n```\nprovider \"grafana\" {\n  url  = var.grafana_url\n  auth = var.grafana_api_key\n}\n```\n\nThen the [data source](https://registry.terraform.io/providers/grafana/grafana/latest/docs/resources/data_source) and [dashboard](https://registry.terraform.io/providers/grafana/grafana/latest/docs/resources/dashboard).\nThe dashboard section links to the file [dashboards/aws-billing.json](https://github.com/JohannesKonings/aws-grafana-billing-dashboard/blob/main/dashboards/aws-billing.json). \n\n```\nresource \"grafana_data_source\" \"cloudwatch\" {\n  type = \"cloudwatch\"\n  name = \"CloudWatch\"\n\n  json_data {\n    default_region = var.region\n    auth_type      = \"keys\"\n  }\n\n  secure_json_data {\n    access_key = var.access_key_grafana\n    secret_key = var.secret_key_grafana\n  }\n}\n\nresource \"grafana_dashboard\" \"metrics\" {\n  config_json = file(\"dashboards/aws-billing.json\")\n}\n```\n\nFor security reasons and flexible sharing of the template, the parameters for secrets and variables like region are in a .env file. This is the [template](https://github.com/JohannesKonings/aws-grafana-billing-dashboard/blob/main/.env_template) for that.\n\n```\n# The URL of the Grafana instance\nexport TF_VAR_grafana_url=\n# The API key of the Grafana instance\nexport TF_VAR_grafana_api_key=\n# IAM user like described here: https://grafana.com/docs/grafana/latest/datasources/cloudwatch/#iam-policies\nexport TF_VAR_access_key_grafana=\nexport TF_VAR_secret_key_grafana=\n# Default region of the data source\nexport TF_VAR_region=\n```\n\nThe declaration of Terraform variables looks like that.\n\n```\nvariable \"grafana_url\" {}\nvariable \"grafana_api_key\" {}\nvariable \"access_key_grafana\" {}\nvariable \"secret_key_grafana\" {}\nvariable \"region\" {}\n```\n\nIn this case it's in the file [variable.tf](https://github.com/JohannesKonings/aws-grafana-billing-dashboard/blob/main/variables.tf) like described [here](https://learn.hashicorp.com/tutorials/terraform/azure-variables).\n\n# Grafana API Key\n\nTerraform can \"communicate\" with Grafana via an API key. \nNavigate to this URL \"https://<<Grafana instance>>/org/apikeys\" and create on with the role \"Admin\".\n\n![grafana api key creation]({{ site.baseurl }}/img/2020-12-19-aws_billing_metrics_grafana_cloud_and_terraform/grafana_api_key_creation.png)\n\nPut the API key into the .env file.\n\n# Usage of the env file\n\nBefore the creation of the S3 Backend and the deployment run the command `source .env`.\n\n# Terraform AWS S3 backend\n\nThis setup so far works for the first deployment. Changes and a redeployment lead to an error because the resource already exists.\nTherefore it's necessary to extend the setup with a [Terraform backend](https://www.terraform.io/docs/backends/index.html). \nIn this example, it's a [S3 backend](https://www.terraform.io/docs/backends/types/s3.html).\n\nUnfortunately, it's not possible to use variables here. This is discussed in this [issue](https://github.com/hashicorp/terraform/issues/13022) with some approaches for workarounds. I use this [one](https://github.com/hashicorp/terraform/issues/13022#issuecomment-482014961), more or less.\n\nConcrete I put a [script](https://github.com/JohannesKonings/aws-grafana-billing-dashboard/blob/main/scripts/terraformInit.sh) around the command `terraform init`. This script can use the environment variables and create a terraform file for the backend.\n\n```bash\n#!/bin/sh\ncat > ./backend.tf << EOF\nterraform {\n  backend \"s3\" {\n    bucket = \"${TF_VAR_s3_bucket_name}\"\n    key    = \"${TF_VAR_backend_key}\"\n    region = \"${TF_VAR_region}\"\n  }\n}\nEOF\n\nterraform init -input=false\n```\n\nThis [script](https://github.com/JohannesKonings/aws-grafana-billing-dashboard/blob/main/scripts/createS3BackendBucket.sh) creates the bucket.\n\n```sh\n#!/bin/sh\n\naws s3api create-bucket --bucket $TF_VAR_s3_bucket_name --region $TF_VAR_region\n```\n\n\nFor the backend, it needs an IAM user. This [script](https://github.com/JohannesKonings/aws-grafana-billing-dashboard/blob/main/scripts/createUser4S3BackendBucket.sh) creates the user and return access and secret key. Put that into the .env file.\n\n```\n# Name of the Terrafrom S3 backend for state handling\nexport TF_VAR_s3_bucket_name=\n# Name of the state file\nexport TF_VAR_backend_key=terraform.tfstate\n# IAM user credentials to access S3 and write the state file\nexport AWS_ACCESS_KEY_ID=\nexport AWS_SECRET_ACCESS_KEY=\n```\n\n```sh\n#!/bin/sh\n\naws iam create-user --user-name terraform_state\n\naws iam create-access-key --user-name terraform_state\n```\n\nThis [script](https://github.com/JohannesKonings/aws-grafana-billing-dashboard/blob/main/scripts/createAndAttachS3BackendBucketPolicy.sh) creates and attach the missing policy.\n\n```sh\n#!/bin/bash\n\ncat > ./scripts/policy << EOF\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": \"s3:ListBucket\",\n      \"Resource\": \"arn:aws:s3:::${TF_VAR_s3_bucket_name}\"\n    },\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\"s3:GetObject\", \"s3:PutObject\"],\n      \"Resource\": \"arn:aws:s3:::${TF_VAR_s3_bucket_name}/*\"\n    }\n  ]\n}\nEOF\n\naws iam create-policy --policy-name terraform_state --policy-document file://scripts/policy\n\nARN=$(aws iam list-policies --query 'Policies[?PolicyName==`terraform_state`].Arn' --output text)\n\naws iam attach-user-policy --policy-arn $ARN --user-name terraform_state\n```\n\n# Deployment commands\n\nOnce the S3 backend is created, you're a few commands away from the deployment.\n\nAt first, the initialization of Terraform, which is wrapped in a script.\n\n`sh scripts/terraformInit.sh`\n\nFor the next commands, the Terraform CLI is sufficient.\n\n[validate:](https://www.terraform.io/docs/commands/validate.html) `terraform validate` \n\n[plan:](https://www.terraform.io/docs/commands/plan.html) `terraform plan`\n\n[apply:](https://www.terraform.io/docs/commands/apply.html) `terraform apply`\n\n# Grafana Dasboard changes\n\nThe dashboard can now be changed directly via the JSON file in the folder dashboards. The easier way is to do that manually in Grafana and copy the changed JSON via the share functionality.\n\n![share grafana dashboard]({{ site.baseurl }}/img/2020-12-19-aws_billing_metrics_grafana_cloud_and_terraform/share_grafana_dashboard.png)\n\n![grafana dashboard export view json]({{ site.baseurl }}/img/2020-12-19-aws_billing_metrics_grafana_cloud_and_terraform/grafana_dashboard_export_view_json.png)\n\nOverwrite the file aws-billing.json with the JSON from Grafana and redeploy.\n\n# CI/CD pipeline\n\nThe local deployment is also possible with a CI/CD pipeline. In [this example](https://github.com/JohannesKonings/aws-grafana-billing-dashboard/blob/main/.github/workflows/deploy2grafana.yml) it's with GitHub actions.\nInstead of the .env file, the variables and credentials coming from GitHub secrets. \n\n# Code\n\n[https://github.com/JohannesKonings/aws-grafana-billing-dashboard](https://github.com/JohannesKonings/aws-grafana-billing-dashboard)\n\n"},"__N_SSG":true}
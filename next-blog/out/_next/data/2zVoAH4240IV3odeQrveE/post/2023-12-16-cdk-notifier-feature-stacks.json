{"pageProps":{"frontmatter":{"layout":"post","title":"Use cdk-notifier to compare changes in pull requests","date":"2023-12-16 08:15:18","published":true,"summary":"See how cdk-notifier can help to compare which cdk changes will be applied after merging a pull request","categories":"aws","thumbnail":"cdk","tags":["aws","cdk","cdk-notifier"]},"content":"\n## Use case\n\nEspecially in serverless environments, features will be created with ephemeral stacks, which will be deleted after merging to the main branch. Comparing the cdk diff between the feature branch and the main branch will help to understand which changes will be applied after merging the pull request.\n\nSome changes, like renaming a dynamodb table or updating more than one dynamodb index, will work if the changes are made before deploying the feature stack but fail if the changes are applied to an existing stack.\n\nThe cdk-notifer will help to identify these changes.\n\n## cdk-notifier\n\nSee here for more information about the cdk-notifier:\n[https://github.com/karlderkaefer/cdk-notifier](https://github.com/karlderkaefer/cdk-notifier)\n\n## GitHub Action\n\nThis setting has a deployed stack from the main branch, for the feature development a new branch `feat1` is created and deployed as a new stack.\n\n![stack-overview]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/stack-overview.png)\n\nIn the pull request the cdk-notifier action is added to the workflow and create a diff from the `feat1` branch files with the BRANCH_NAME env variable for `main` to run the diff agianst the `main` stack.\nThe diff output will be added to the pull request as a comment via the cdk-notifier.\n\n```yaml\n      - name: Check diff to main\n        run: |\n          npm ci  \n          echo \"check the diff to main\"\n          BRANCH_NAME=main npx cdk diff --app cdk.out --progress=events &> >(tee cdk.log)\n          echo \"create cdk-notifier report\"\n          echo \"BRANCH_NAME: $BRANCH_NAME\"\n          echo \"GITHUB_OWNER: $GITHUB_OWNER\"\n          echo \"GITHUB_REPO: $GITHUB_REPO\"\n          cdk-notifier \\\n          --owner ${{ env.GITHUB_OWNER }} \\\n          --repo ${{ env.GITHUB_REPO }} \\\n          --token ${{ secrets.GITHUB_TOKEN }} \\\n          --log-file ./cdk.log \\\n          --tag-id diff-to-main \\\n          --pull-request-id ${{ env.PULL_REQUEST_ID }} \\\n          --vcs github \\\n          --ci circleci \\\n          --template extendedWithResources\n```\n[https://github.com/JohannesKonings/cdk-notifier-examples/blob/main/.github/workflows/cdk-diff.yml](https://github.com/JohannesKonings/cdk-notifier-examples/blob/main/.github/workflows/cdk-diff.yml)\n\n![pipeline in pull request]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/pipeline-in-pull-request.png)\n\nThe comment looks like this:\n\n![PR comment]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/pr-comment.png)\n[https://github.com/JohannesKonings/cdk-notifier-examples/pull/4#issuecomment-1858909147](https://github.com/JohannesKonings/cdk-notifier-examples/pull/4#issuecomment-1858909147)\n\nThe extended template parameter of the cdk-notifier displays in this setting also a warning that the dynamodb requires a replacement.\nIn some cases, this could be unintended and be reverted securely in the feature branch before merging.\nThat is a nice feature besides the overview of the changes, which is itself helpful in making these changes more visible.\n\nAfter the merge, the feature stack will be destroyed, and the main stack will be updated.\n\n![pipeline after merge]({{ site.baseurl }}/img/2023-12-16-cdk-notifier-feature-stacks/pipeline-after-merge.png)\n\n\n## Code\n\n[https://github.com/JohannesKonings/cdk-notifier-examples](https://github.com/JohannesKonings/cdk-notifier-examples)\n\n"},"__N_SSG":true}
{"pageProps":{"frontmatter":{"layout":"post","title":"Example how to use zod with CDK serverless v2","date":"2023-08-19 08:15:18","published":true,"summary":"CDK serverless v2 is for using type saftey develepmonet base on schemas like openAPI. This post is a example how to use zod with CDK serverless v2","categories":"aws","thumbnail":"zod","tags":["aws","aws cdk","projen","zod"]},"content":"\r\nThe [AWS CDK Serverless Toolsuite](https://github.com/taimos/cdk-serverless) from [Thorsten Hoeger](https://github.com/hoegertn) helps, among others, to deploy an API Gateway from [OpenApi specs](https://www.openapis.org/) and a DynamoDb from [DynamoDb onetable data modeling](https://doc.onetable.io/). The advantage is to leverage the type safety from Typscript generated from these files.\r\n\r\nThat helps during the development cycle, but a runtime Typescript is Javascript without any type checking. This post is about enhancing this setup with [zod](https://github.com/colinhacks/zod) to validate the types during runtime.\r\n\r\nThe workflow so far is to create a definition and generate Typescript types from that. Now the workflow has a step before to create a zod schema and derive the definitions from the zod schema.\r\n\r\n## Type checking without zod\r\n\r\nAs you can see, the types are available at development time via the OpenApi spec.\r\n\r\n![add Todo title type]({{ site.baseurl }}/img/2023-08-19-cdk-serverless-v2-demo-with-zod/addTodoTitleType.png)\r\n\r\nThis is because of the defined components in this [openApi spec](https://github.com/JohannesKonings/cdk-serverless-v2-demo/blob/main/src/definitions/myapi.yaml)\r\n\r\n```yaml\r\ncomponents:\r\n  schemas:\r\n    Todo:\r\n      type: object\r\n      required:\r\n        - id\r\n        - state\r\n        - title\r\n        - description\r\n        - lastUpdate\r\n      properties:\r\n        id: \r\n          type: string\r\n        state: \r\n          type: string\r\n        title: \r\n          type: string\r\n        description: \r\n          type: string\r\n        lastUpdate:\r\n          type: string\r\n          format: date-time\r\n    AddTodo:\r\n      type: object\r\n      required:\r\n        - title\r\n        - description\r\n      properties:\r\n        title: \r\n          type: string\r\n        description: \r\n          type: string\r\n```\r\n\r\nBut that didn't prevent you from using the false type during runtime.\r\n\r\n![add Todo title as number]({{ site.baseurl }}/img/2023-08-19-cdk-serverless-v2-demo-with-zod/addTodoTitleAsNumber.png)\r\n\r\n## Type checking with zod\r\n\r\nWith a one-line parsing command, zod checks all the types.\r\n\r\n![add Todo zod parsing]({{ site.baseurl }}/img/2023-08-19-cdk-serverless-v2-demo-with-zod/addTodoZodParsing.png)\r\n\r\nFurthermore, zod has some [string-specific validations](https://github.com/colinhacks/zod#strings) that can check if the email is valid.\r\n\r\n```typescript\r\nnotificationsEmail: z.string().email(),\r\n```\r\n![add Todo validation result]({{ site.baseurl }}/img/2023-08-19-cdk-serverless-v2-demo-with-zod/addTodoValidationResult.png)\r\n\r\n\r\n## Implementation\r\n\r\nTo implement that, first, the zod schemas are needed. [This setup](https://github.com/JohannesKonings/cdk-serverless-v2-demo/blob/main/src/zod/schema-todo.ts) has three schemas.\r\nOne for the API request, one for the API response and one how the data is stored.\r\n\r\nWith zod it's possible to reference existing schema an extend fields or omit some.\r\n\r\n```typescript\r\nimport * as z from 'zod';\r\n\r\nexport const schemaTodoApi = z.object({\r\n  id: z.string().uuid(),\r\n  state: z.enum(['OPEN', 'IN PROGRESS', 'DONE']).default('OPEN'),\r\n  title: z.string(),\r\n  finishedInDays: z.number().int().positive(),\r\n  notificationsEmail: z.string().email(),\r\n  description: z.string().optional(),\r\n  lastUpdate: z.string().datetime(),\r\n});\r\n\r\nexport const schemaAddTodoApi = schemaTodoApi.omit({\r\n  id: true,\r\n  state: true,\r\n  lastUpdate: true,\r\n});\r\n\r\nexport const schemaTodoDdb = schemaTodoApi.extend({\r\n  lastUpdated: z.string().datetime(),\r\n}).omit({ lastUpdate: true });\r\n```\r\n\r\n### openApi\r\n\r\nTo create the openApi spec I'm using the `@asteasolutions/zod-to-openapi` package. zod has listed some more packages [here](https://github.com/colinhacks/zod#zod-to-x) which can be used.\r\n\r\nThe definition of the apiSpec is now created via Typescript as you can see [here](https://github.com/JohannesKonings/cdk-serverless-v2-demo/blob/main/src/zod/openapi.ts) and generate a yaml file.\r\n\r\n```typescript\r\nimport fs from 'node:fs';\r\nimport {\r\n  extendZodWithOpenApi,\r\n  OpenAPIRegistry,\r\n  OpenApiGeneratorV3,\r\n} from '@asteasolutions/zod-to-openapi';\r\nimport yaml from 'js-yaml';\r\nimport * as z from 'zod';\r\nimport { schemaAddTodoApi, schemaTodoApi } from './schema-todo';\r\n\r\nextendZodWithOpenApi(z);\r\n\r\nconst registry = new OpenAPIRegistry();\r\n\r\nconst apiKeyComponent = registry.registerComponent(\r\n  'securitySchemes',\r\n  'api_key',\r\n  {\r\n    type: 'apiKey',\r\n    name: 'x-api-key',\r\n    in: 'header',\r\n  },\r\n);\r\n\r\nregistry.register(\r\n  'Todo',\r\n  schemaTodoApi.openapi({}),\r\n);\r\nregistry.register(\r\n  'AddTodo',\r\n  schemaAddTodoApi.openapi({}),\r\n);\r\n\r\nregistry.registerPath({\r\n  method: 'get',\r\n  path: '/todos',\r\n  summary: 'return list of todos',\r\n  tags: ['admin'],\r\n  security: [{ [apiKeyComponent.name]: [] }],\r\n  operationId: 'getTodos',\r\n  responses: {\r\n    200: {\r\n      description: 'successful operation',\r\n      content: {\r\n        'application/json': {\r\n          schema: {\r\n            type: 'array',\r\n            items: {\r\n              $ref: '#/components/schemas/Todo',\r\n            },\r\n          },\r\n        },\r\n        'text/calendar': {\r\n          schema: {\r\n            type: 'string',\r\n          },\r\n        },\r\n      },\r\n    },\r\n  },\r\n});\r\nregistry.registerPath({\r\n  'method': 'post',\r\n  'path': '/todos',\r\n  'summary': 'add new todo',\r\n  'tags': ['admin'],\r\n  'security': [{ [apiKeyComponent.name]: [] }],\r\n  'operationId': 'addTodo',\r\n  'requestBody': {\r\n    required: true,\r\n    content: {\r\n      'application/json': {\r\n        schema: {\r\n          $ref: '#/components/schemas/AddTodo',\r\n        },\r\n      },\r\n    },\r\n  },\r\n  'responses': {\r\n    201: {\r\n      description: 'successful operation',\r\n      content: {\r\n        'application/json': {\r\n          schema: {\r\n            $ref: '#/components/schemas/Todo',\r\n          },\r\n        },\r\n      },\r\n    },\r\n    401: {\r\n      description: 'you are not logged in',\r\n      content: {},\r\n    },\r\n    403: {\r\n      description: 'you are not authorized to add todos',\r\n      content: {},\r\n    },\r\n  },\r\n  'x-codegen-request-body-name': 'body',\r\n});\r\nregistry.registerPath({\r\n  method: 'post',\r\n  path: '/todos/{id}',\r\n  summary: 'get a todo by its id',\r\n  tags: ['admin'],\r\n  security: [{ [apiKeyComponent.name]: [] }],\r\n  operationId: 'getTodoById',\r\n  responses: {\r\n    200: {\r\n      description: 'successful operation',\r\n      content: {\r\n        'application/json': {\r\n          schema: {\r\n            $ref: '#/components/schemas/Todo',\r\n          },\r\n        },\r\n      },\r\n    },\r\n    401: {\r\n      description: 'you are not logged in',\r\n      content: {},\r\n    },\r\n    403: {\r\n      description: 'you are not authorized to add todos',\r\n      content: {},\r\n    },\r\n  },\r\n});\r\nregistry.registerPath({\r\n  method: 'delete',\r\n  path: '/todos/{id}',\r\n  summary: 'delete a todo',\r\n  tags: ['admin'],\r\n  security: [{ [apiKeyComponent.name]: [] }],\r\n  operationId: 'removeTodo',\r\n  responses: {\r\n    200: {\r\n      description: 'successful operation',\r\n      content: {},\r\n    },\r\n  },\r\n});\r\n\r\nconst generator = new OpenApiGeneratorV3(registry.definitions);\r\n\r\nconst generatorDocument = generator.generateDocument({\r\n  openapi: '3.0.1',\r\n  info: {\r\n    version: '1.0',\r\n    title: 'Serverless Demo with zod',\r\n  },\r\n  tags: [\r\n    {\r\n      name: 'info',\r\n    },\r\n    {\r\n      name: 'admin',\r\n    },\r\n  ],\r\n});\r\n\r\nconst yamlString = yaml.dump(generatorDocument, { indent: 2 });\r\n\r\nfs.writeFileSync('./src/definitions/myapi-zod.yaml', yamlString);\r\n```\r\n\r\n### onetable\r\n\r\nUnfortunately, for onetable didn't exist a npm package. So the conversion is made from scratch.\r\n[This](https://github.com/JohannesKonings/cdk-serverless-v2-demo/blob/main/src/zod/onetable.ts) is how it looks like.\r\n\r\n```typescript\r\nimport fs from 'node:fs';\r\nimport { z } from 'zod';\r\nimport { schemaTodoDdb } from './schema-todo';\r\n\r\nconst modelTodoDdb = {\r\n  PK: {\r\n    type: 'string',\r\n    value: 'TODO#${id}',\r\n  },\r\n  SK: {\r\n    type: 'string',\r\n    value: 'TODO#${id}',\r\n  },\r\n  id: {\r\n    type: 'string',\r\n    required: true,\r\n    generate: 'uuid',\r\n  },\r\n  GSI1PK: {\r\n    type: 'string',\r\n    value: 'TODOS',\r\n  },\r\n  GSI1SK: {\r\n    type: 'string',\r\n    value: '${state}#${title}',\r\n  },\r\n};\r\n\r\nconst schemaTodoValues = schemaTodoDdb.keyof().Values;\r\n\r\nconst modelTodoFields = Object.keys(schemaTodoValues).reduce((acc, key) => {\r\n  const keyOfSchemaTodoKeyValues = key as keyof typeof schemaTodoValues;\r\n  const shapeType = schemaTodoDdb.shape[keyOfSchemaTodoKeyValues];\r\n\r\n  const { type, required, generate, enumValues, defaultValue } = deriveAttributes(shapeType);\r\n\r\n  return {\r\n    ...acc,\r\n    [key]: {\r\n      type: type,\r\n      required: required,\r\n      generate: generate,\r\n      enum: enumValues,\r\n      default: defaultValue,\r\n    },\r\n  };\r\n}, {});\r\n\r\nfunction deriveAttributes(shapeType: z.ZodType<any, any>) {\r\n  let type = '';\r\n  let required = false;\r\n  let generate = undefined;\r\n  let enumValues = [] as string[];\r\n  let defaultValue = undefined;\r\n\r\n  if (shapeType === undefined) {\r\n    throw new Error('type is undefined');\r\n  } else if (shapeType instanceof z.ZodString) {\r\n    type = 'string';\r\n    required = true;\r\n    generate = shapeType.isUUID ? 'uuid' : undefined;\r\n  } else if (shapeType instanceof z.ZodNumber) {\r\n    type = 'number';\r\n    required = true;\r\n  } else if (shapeType instanceof z.ZodEnum) {\r\n    required = true;\r\n    type = 'string';\r\n    enumValues = shapeType._def.values;\r\n  } else if (shapeType instanceof z.ZodDefault) {\r\n    required = true;\r\n    defaultValue = shapeType._def.defaultValue();\r\n    const { type: typeInnerType, enumValues: enumInnerType } = deriveAttributes(shapeType._def.innerType);\r\n    type = typeInnerType;\r\n    enumValues = enumInnerType as string[];\r\n  } else if (shapeType instanceof z.ZodOptional) {\r\n    required = false;\r\n    const { type: typeInnerType } = deriveAttributes(shapeType._def.innerType);\r\n    type = typeInnerType;\r\n  } else {\r\n    console.log('shapeType', shapeType);\r\n    throw new Error('type is not supported');\r\n  }\r\n  return {\r\n    type,\r\n    required: required ? true : undefined,\r\n    generate,\r\n    enumValues: enumValues && enumValues.length > 0 ? enumValues : undefined,\r\n    defaultValue,\r\n  };\r\n}\r\n\r\nexport const modelTodo = {\r\n  ...modelTodoDdb,\r\n  ...modelTodoFields,\r\n};\r\n\r\nconst onetable = {\r\n  indexes: {\r\n    primary: {\r\n      hash: 'PK',\r\n      sort: 'SK',\r\n    },\r\n    GSI1: {\r\n      hash: 'GSI1PK',\r\n      sort: 'GSI1SK',\r\n      project: 'all',\r\n    },\r\n    LSI1: {\r\n      type: 'local',\r\n      sort: 'lastUpdated',\r\n      project: [\r\n        'id',\r\n        'lastUpdated',\r\n        'title',\r\n      ],\r\n    },\r\n  },\r\n  models: {\r\n    Todo: modelTodo,\r\n  },\r\n  version: '0.1.0',\r\n  format: 'onetable:1.1.0',\r\n  queries: {},\r\n};\r\n\r\nfs.writeFileSync('./src/definitions/mymodel-zod.json', JSON.stringify(onetable, null, 2));\r\n```\r\n\r\n### Integration into the file creation workflow\r\n\r\nThe definition files can now be generated based on a zod schema. So that that will happen together with generating the files from the spec the projen.ts file need to be enhanced. This will create two commands before.\r\n\r\n```typescript\r\nconst taskDefinitionsCreation = project.addTask('definitionsCreation', {\r\n  steps: [\r\n    { exec: 'ts-node ./src/zod/openapi.ts' },\r\n    { exec: 'ts-node ./src/zod/onetable.ts' },\r\n  ],\r\n});\r\nproject.defaultTask!.prependSpawn(taskDefinitionsCreation);\r\n```\r\n\r\nThan the steps look like this.\r\n\r\n```JSON\r\n  \"default\": {\r\n      \"name\": \"default\",\r\n      \"description\": \"Synthesize project files\",\r\n      \"steps\": [\r\n        {\r\n          \"spawn\": \"definitionsCreation\"\r\n        },\r\n        {\r\n          \"exec\": \"ts-node --project tsconfig.dev.json .projenrc.ts\"\r\n        },\r\n        {\r\n          \"spawn\": \"generate:api:myapi\"\r\n        }\r\n      ]\r\n    },\r\n```\r\n\r\nNow with the command `npm run projen` the definition file are created derived from zod and from that on the workflow is like before.\r\n\r\n## Code\r\n\r\n[https://github.com/JohannesKonings/cdk-serverless-v2-demo](https://github.com/JohannesKonings/cdk-serverless-v2-demo)\r\n\r\n"},"__N_SSG":true}
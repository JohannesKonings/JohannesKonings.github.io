{"pageProps":{"frontmatter":{"layout":"post","title":"Use Steampipe to select your AWS resources across SSO accounts with SQL","date":"2023-09-08 08:15:18","published":true,"summary":"See how this setup can help to discover your AWS resources across all SSO accounts with a mix of Steampipe, docker, bash scripts, and AWS CLI","categories":"aws","thumbnail":"steampipe","tags":["aws","steampipe","docker"]},"content":"\n## Use case\n\nYou are in charge of several AWS accounts within an AWS Organisation and need to check the resources across these accounts. E.g., to check which are the configured runtimes for the lambdas.\n\n## Approach with Steampipe\n\n[Steampipe](https://steampipe.io/) is a tool to query data from different providers. Among others, there is a [plugin for AWS](https://hub.steampipe.io/plugins/turbot/aws).\n\nThe big plus is that Steampipe provides the ability to query more than one account with a query with [aggregator connection](https://steampipe.io/docs/managing/connections#using-aggregators)\n\nThis is how the result will look like for my AWS SSO accounts.\n\n![query result]({{ site.baseurl }}/img/2023-09-08-aws-sso-steampipe/query-result.png)\n\nMore about Steampipe and AWS: https://dev.to/aws-builders/easily-query-your-cloud-inventory-with-steampipe-2af3\n\n## Setup\n\nIt's necessary to have a link between AWS CLI profiles and Steampipe connection for the AWS SSO accounts that can be recreated without any effects on the local setup, which is created inside a docker image. This [docker image](https://github.com/JohannesKonings/aws-sso-steampipe/blob/main/Dockerfile) is based on Steampipe with additional installation of some tools, the AWS CLI and the AWS steampipe plugin.\n\n### Docker\n\n```Dockerfile\nFROM ghcr.io/turbot/steampipe\n\n# Setup prerequisites (as root)\nUSER root:0\nRUN apt-get update -y \\\n && apt-get install -y git curl unzip jq\n\nRUN curl \"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip\" -o \"awscliv2.zip\" \\\n && unzip awscliv2.zip \\\n && ./aws/install \\\n && rm -rf awscliv2.zip ./aws\n\n\n# Install the aws and steampipe plugins for Steampipe (as steampipe user).\nUSER steampipe:0\nRUN  steampipe plugin install steampipe aws\n```\nThe Steampipe docu is here: https://steampipe.io/docs/managing/containers\n\nAfter creating the image with `docker build -t steampipe-query .`. The container can be created with the following command.\n\n```bash\ndocker run --entrypoint /bin/bash -it \\\n--mount type=bind,source=\"${PWD}/queries\",target=/workspace/queries \\\n--mount type=bind,source=\"${PWD}/scripts\",target=/workspace/scripts \\\n--mount type=bind,source=\"${PWD}/.env\",target=/workspace/.env \\\n--name steampipe-query \\\nsteampipe-query \n```\n\nThese are the commands to use the container again `docker start -a steampipe-query` and `docker exec -it steampipe-query /bin/bash`.\n\n## Queries\n\nOne of the mount points was the folder queries, which contain, in this example, the SQL to check the lambda runtime.\n\n```SQL\nselect\n  account_id,\n  _ctx ->> 'connection_name' as connection_name,\n  runtime,\n  count(*),\n  SUM(COUNT(*)) OVER() AS total_count\nfrom\n  aws_all.aws_lambda_function\nwhere runtime not in ('nodejs18.x', 'nodejs16.x', 'python3.9')\ngroup by\n  account_id,\n  _ctx,\n  runtime\norder by\n  connection_name,\n  runtime,\n  count;\n```\n\nThe command to run this query is `steampipe query queries/lambda-runtime.sql`. This will work after the scripts have created the profiles and connections config.\n\n## Scripts\n\nThe other mount points are scripts and the env file. The first step is to set the needed env variable values and then run the script `./scripts/create-aws-config.sh` inside the container, which creates the file ~/.aws/config with SS0 session values.\n\n```env\nSSO_START_URL= # https://<your-aws-account-id>.awsapps.com/start\nSSO_SESSION_NAME= # <your session name, it's just a name>\nSSO_REGION= # <your region, e.g. us-east-1>\n```\nAs next step source the env file with `source .env` to get the value for the session name. Than run the login to aws sso with the command `aws sso login --sso-session $SSO_SESSION_NAME`.\n\nIt will look like this.\n\n![sso login]({{ site.baseurl }}/img/2023-09-08-aws-sso-steampipe/sso-login.png)\n\nOpen the link in the browser and put in the code.\n\n![authorize request]({{ site.baseurl }}/img/2023-09-08-aws-sso-steampipe/authorize-request.png)\n\nThen, allow the access.\n\n![allow sso to access data]({{ site.baseurl }}/img/2023-09-08-aws-sso-steampipe/allow-sso-to-access-data.png)\n\n![successfully logged in]({{ site.baseurl }}/img/2023-09-08-aws-sso-steampipe/successfully-logged-in.png)\n\nAfter it's confirmed, you can create profiles with the script `./scripts/create-aws-profiles.sh` inside the container. This will create a profile for each account in the aws config file ~/.aws/config (after confirmation) with a suffix of the assigned roles for the accounts.\n\nThe scipt is adapted from this gist: https://gist.github.com/lukeplausin/3cfedc29755e184ef526b504c77ffe70\n\nThe last step for the setup is to create the connections for Steampipe with the script `./scripts/create-aws-connections.sh` inside the container. This will create a connection for each profile in the AWS config file ~/.aws/config.\nNot every role is allowed to query the data, so it's necessary to set the env variable `ALLOWED_ROLES` with the roles allowed to query the data. The roles are comma-separated. E.g. \n\n`ALLOWED_ROLES=\"AWSReadOnlyAccess,AWSAdministratorAccess\"`\n\nAnd now it's possible to run the queries with steampipe ðŸ¥³\n\n## Code\n\n[https://github.com/JohannesKonings/aws-sso-steampipe](https://github.com/JohannesKonings/aws-sso-steampipe)\n\n"},"__N_SSG":true}